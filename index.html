<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Garde Alternée</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .parent1-color {
            background-color: #4299e1;
            color: white;
        }
        .parent2-color {
            background-color: #ed64a6;
            color: white;
        }
        .fc-event {
            cursor: pointer;
        }
        .transition-marker {
            background-color: #f6ad55;
            border-radius: 50%;
            width: 12px;
            height: 12px;
            display: inline-block;
        }
        #map {
            height: 400px;
            width: 100%;
            border-radius: 0.5rem;
        }
        .task-item {
            transition: all 0.3s ease;
        }
        .task-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .task-completed {
            background-color: #e5e7eb; /* gray-200 */
            text-decoration: line-through;
        }
        .dark-mode {
            background-color: #1a202c;
            color: #e2e8f0;
        }
        .dark-mode .bg-white {
            background-color: #2d3748;
        }
        .dark-mode .bg-gray-100 {
            background-color: #4a5568;
        }
         .dark-mode .bg-gray-50 {
            background-color: #374151; /* Adjusted for better contrast in dark mode */
        }
        .dark-mode .text-gray-800 {
            color: #e2e8f0;
        }
         .dark-mode .text-gray-700 {
            color: #cbd5e0; /* Lighter gray for text in dark mode */
        }
         .dark-mode .text-gray-600 {
            color: #a0aec0; 
        }
        .dark-mode .text-gray-500 {
            color: #718096;
        }
        .dark-mode .border-gray-200 {
            border-color: #4a5568;
        }
        .dark-mode .border-gray-300 {
            border-color: #4a5568;
        }
        .dark-mode .task-completed {
            background-color: #374151; 
        }
        .dark-mode .bg-orange-100 { background-color: #4a5568; border-color: #dd6b20; }
        .dark-mode .text-orange-500 { color: #dd6b20; }
        .dark-mode .bg-blue-100 { background-color: #2b6cb022; }
        .dark-mode .text-blue-800 { color: #63b3ed; }
        .dark-mode .bg-pink-100 { background-color: #d53f8c22; }
        .dark-mode .text-pink-800 { color: #f687b3; }
        .dark-mode .bg-red-100 { background-color: #c5303022; }
        .dark-mode .text-red-800 { color: #fc8181; }
        .dark-mode .bg-green-100 { background-color: #38a16922; }
        .dark-mode .text-green-800 { color: #68d391; }
        .dark-mode .bg-yellow-100 { background-color: #d69e2e22; }
        .dark-mode .text-yellow-800 { color: #f6e05e; }
        .dark-mode .bg-purple-100 { background-color: #805ad522; }
        .dark-mode .text-purple-800 { color: #b794f4; }
        .dark-mode .bg-indigo-50 { background-color: #5a67d822; }


        @media print {
            .no-print {
                display: none;
            }
            .page-break {
                page-break-after: always;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <header class="bg-blue-600 text-white shadow-lg no-print">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold flex items-center">
                <i class="fas fa-child mr-2"></i>
                <i class="fas fa-exchange-alt mx-1"></i>
                <i class="fas fa-child mr-2"></i>
                Garde Alternée
            </h1>
            <div class="flex items-center">
                <div class="mr-4">
                    <span id="currentParent" class="font-semibold">Parent 1</span>
                    <button onclick="toggleParent()" class="ml-2 bg-white text-blue-600 px-2 py-1 rounded-full text-xs">
                        Changer
                    </button>
                </div>
                <button id="darkModeToggle" class="bg-blue-700 p-2 rounded-full">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </div>
        <nav class="bg-blue-700">
            <div class="container mx-auto px-4">
                <ul class="flex overflow-x-auto whitespace-nowrap py-2" id="mainTabs">
                    <li>
                        <button onclick="switchTab('dashboard')" class="text-white px-4 py-2 mx-1 rounded-lg hover:bg-blue-800 tab-button active" data-tab="dashboard">
                            <i class="fas fa-home mr-2"></i>Tableau de bord
                        </button>
                    </li>
                    <li>
                        <button onclick="switchTab('calendar')" class="text-white px-4 py-2 mx-1 rounded-lg hover:bg-blue-800 tab-button" data-tab="calendar">
                            <i class="far fa-calendar-alt mr-2"></i>Calendrier
                        </button>
                    </li>
                    <li>
                        <button onclick="switchTab('transitions')" class="text-white px-4 py-2 mx-1 rounded-lg hover:bg-blue-800 tab-button" data-tab="transitions">
                            <i class="fas fa-exchange-alt mr-2"></i>Transitions
                        </button>
                    </li>
                    <li>
                        <button onclick="switchTab('children')" class="text-white px-4 py-2 mx-1 rounded-lg hover:bg-blue-800 tab-button" data-tab="children">
                            <i class="fas fa-child mr-2"></i>Enfants
                        </button>
                    </li>
                    <li>
                        <button onclick="switchTab('tasks')" class="text-white px-4 py-2 mx-1 rounded-lg hover:bg-blue-800 tab-button" data-tab="tasks">
                            <i class="fas fa-tasks mr-2"></i>Tâches
                        </button>
                    </li>
                    <li>
                        <button onclick="switchTab('stats')" class="text-white px-4 py-2 mx-1 rounded-lg hover:bg-blue-800 tab-button" data-tab="stats">
                            <i class="fas fa-chart-pie mr-2"></i>Statistiques
                        </button>
                    </li>
                    <li>
                        <button onclick="switchTab('settings')" class="text-white px-4 py-2 mx-1 rounded-lg hover:bg-blue-800 tab-button" data-tab="settings">
                            <i class="fas fa-cog mr-2"></i>Paramètres
                        </button>
                    </li>
                </ul>
            </div>
        </nav>
    </header>

    <main class="container mx-auto px-4 py-6">
        <!-- DASHBOARD TAB -->
        <section id="dashboard" class="tab-content active">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-2">
                    <div class="bg-white rounded-lg shadow-md p-4 mb-6">
                        <h2 class="text-xl font-bold mb-4 text-blue-600">Prochaine transition</h2>
                        <div id="nextTransitionDashboard" class="bg-orange-100 border-l-4 border-orange-500 p-4 rounded">
                           <p>Chargement...</p>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow-md p-4 mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-blue-600">Calendrier de garde</h2>
                            <button onclick="switchTab('calendar')" class="text-blue-500 hover:underline text-sm">
                                Voir tout <i class="fas fa-arrow-right ml-1"></i>
                            </button>
                        </div>
                        <div id="miniCalendar" class="h-64"></div>
                    </div>

                    <div class="bg-white rounded-lg shadow-md p-4">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-blue-600">Tâches à venir</h2>
                            <button onclick="switchTab('tasks')" class="text-blue-500 hover:underline text-sm">
                                Voir tout <i class="fas fa-arrow-right ml-1"></i>
                            </button>
                        </div>
                        <ul id="dashboardTasksList" class="space-y-3">
                           {/* Populated by JS */}
                        </ul>
                    </div>
                </div>

                <div class="md:col-span-1">
                    <div class="bg-white rounded-lg shadow-md p-4 mb-6">
                        <h2 class="text-xl font-bold mb-4 text-blue-600">Profils enfants</h2>
                        <div id="dashboardChildrenList" class="space-y-4">
                            {/* Child profiles for dashboard - will be populated by JS */}
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow-md p-4">
                        <h2 class="text-xl font-bold mb-4 text-blue-600">Répartition du temps</h2>
                        <canvas id="custodyChart" width="400" height="200"></canvas>
                        <div class="grid grid-cols-2 mt-4 gap-4">
                            <div class="text-center">
                                <div id="dashboardParent1Percentage" class="text-xl font-bold p-2 rounded parent1-color">0%</div>
                                <p id="dashboardParent1Name" class="text-sm mt-1">Parent 1</p>
                            </div>
                            <div class="text-center">
                                <div id="dashboardParent2Percentage" class="text-xl font-bold p-2 rounded parent2-color">0%</div>
                                <p id="dashboardParent2Name" class="text-sm mt-1">Parent 2</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- CALENDAR TAB -->
        <section id="calendar" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="md:col-span-3">
                    <div class="bg-white rounded-lg shadow-md p-4 mb-6">
                        <h2 class="text-xl font-bold mb-4 text-blue-600">Calendrier de garde</h2>
                        <div id="fullCalendar" class="h-96"></div>
                    </div>
                </div>
                <div class="md:col-span-1">
                    <div class="bg-white rounded-lg shadow-md p-4 mb-6">
                        <h2 class="text-xl font-bold mb-4 text-blue-600">Configuration du planning</h2>
                        <form id="custodyConfigForm">
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="custodyModel">
                                    Modèle de garde
                                </label>
                                <select id="custodyModel" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                    <option value="week-alt">Semaine paire/impaire</option>
                                    <option value="1-1">1/1 semaine</option>
                                    <option value="2-2" disabled>2/2 semaines (à implémenter)</option>
                                    <option value="5-5-2-2" disabled>5/5/2/2 jours (à implémenter)</option>
                                    <option value="custom" disabled>Personnalisé (à implémenter)</option>
                                </select>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="cycleStartDate">
                                    Date de début du cycle
                                </label>
                                <input type="date" id="cycleStartDate" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" value="2023-01-01">
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-bold mb-2">
                                    Couleurs
                                </label>
                                <div class="flex space-x-2">
                                    <div>
                                        <span class="block text-xs mb-1">Parent 1</span>
                                        <input type="color" id="parent1CalendarColor" value="#4299e1" class="w-full h-8 rounded">
                                    </div>
                                    <div>
                                        <span class="block text-xs mb-1">Parent 2</span>
                                        <input type="color" id="parent2CalendarColor" value="#ed64a6" class="w-full h-8 rounded">
                                    </div>
                                </div>
                            </div>
                            <button type="button" id="applyCustodyConfigButton" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full">
                                Appliquer les modifications
                            </button>
                        </form>
                    </div>

                    <div class="bg-white rounded-lg shadow-md p-4">
                        <h2 class="text-lg font-bold mb-3 text-blue-600">Ajouter une exception</h2>
                        <form id="addExceptionForm">
                            <div class="mb-3">
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="exceptionDate">
                                    Date
                                </label>
                                <input type="date" id="exceptionDate" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            </div>
                            <div class="mb-3">
                                <label class="block text-gray-700 text-sm font-bold mb-2">
                                    Parent
                                </label>
                                <div class="flex space-x-2">
                                    <button type="button" id="exceptionParent1Button" class="w-1/2 parent1-color py-2 px-3 rounded">Parent 1</button>
                                    <button type="button" id="exceptionParent2Button" class="w-1/2 bg-gray-200 py-2 px-3 rounded">Parent 2</button>
                                </div>
                                <input type="hidden" id="selectedExceptionParent" value="">
                            </div>
                            <div class="mb-3">
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="exceptionReason">
                                    Raison (optionnel)
                                </label>
                                <input type="text" id="exceptionReason" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Ex: Voyage scolaire">
                            </div>
                            <button type="button" id="addExceptionButton" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full">
                                Ajouter l'exception
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </section>

        <!-- TRANSITIONS TAB -->
        <section id="transitions" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <div class="bg-white rounded-lg shadow-md p-4 mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-blue-600">Prochaines transitions</h2>
                            <button id="addManualTransitionButton" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg text-sm">
                                <i class="fas fa-plus mr-1"></i> Ajouter
                            </button>
                        </div>
                        <ul id="upcomingTransitionsList" class="space-y-4">
                           {/* Populated by JS */}
                           <li>Aucune transition à venir.</li>
                        </ul>
                    </div>

                    <div class="bg-white rounded-lg shadow-md p-4">
                        <h2 class="text-xl font-bold mb-4 text-blue-600">Historique des transitions</h2>
                        <ul id="pastTransitionsList" class="space-y-3 max-h-80 overflow-y-auto">
                           {/* Populated by JS */}
                           <li>Aucune transition passée.</li>
                        </ul>
                    </div>
                </div>

                <div>
                    <div class="bg-white rounded-lg shadow-md p-4 mb-6">
                        <h2 class="text-xl font-bold mb-4 text-blue-600">Carte des lieux de transition</h2>
                        <div id="map" class="mb-4"></div>
                        <h3 class="font-semibold mb-2">Lieux enregistrés</h3>
                        <ul id="transitionLocationsList" class="space-y-2">
                            {/* Populated by JS */}
                            <li>Aucun lieu enregistré.</li>
                        </ul>
                        <button id="addTransitionLocationButton" class="mt-4 bg-green-500 hover:bg-green-600 text-white w-full py-2 rounded-lg">
                            <i class="fas fa-plus mr-1"></i> Ajouter un lieu
                        </button>
                    </div>

                    <div class="bg-white rounded-lg shadow-md p-4">
                        <h2 class="text-xl font-bold mb-4 text-blue-600">Paramètres des transitions</h2>
                        <form id="transitionSettingsForm">
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="defaultTransitionTime">
                                    Heure par défaut
                                </label>
                                <input type="time" id="defaultTransitionTime" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" value="18:00">
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="defaultTransitionLocationId">
                                    Lieu par défaut
                                </label>
                                <select id="defaultTransitionLocationId" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                    <option value="">-- Sélectionner un lieu --</option>
                                    {/* Populated by JS from settingsData.transitionLocations */}
                                </select>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-bold mb-2">
                                    Notifications
                                </label>
                                <div class="space-y-2">
                                    <div class="flex items-center">
                                        <input type="checkbox" id="notifyDayBefore" class="mr-2">
                                        <label for="notifyDayBefore">La veille de la transition</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="notifyHourBefore" class="mr-2">
                                        <label for="notifyHourBefore">1 heure avant la transition</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="requestConfirmTransition" class="mr-2">
                                        <label for="requestConfirmTransition">Demander confirmation</label>
                                    </div>
                                </div>
                            </div>
                            <button type="button" id="saveTransitionSettingsButton" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full">
                                Enregistrer les paramètres
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </section>

        <!-- CHILDREN TAB -->
        <section id="children" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-1">
                    <div class="bg-white rounded-lg shadow-md p-4 mb-6">
                        <h2 class="text-xl font-bold mb-4 text-blue-600">Profils enfants</h2>
                        <ul id="childrenList" class="space-y-2">
                            {/* Children list will be populated by JS */}
                        </ul>
                    </div>
                </div>

                <div class="md:col-span-2">
                    <div id="childProfile" class="bg-white rounded-lg shadow-md p-4">
                        {/* Child profile details or form will be populated by JS */}
                        <div class="flex justify-between items-center mb-6">
                            <h2 id="childProfileTitle" class="text-2xl font-bold text-blue-600">Sélectionnez un enfant</h2>
                            <button id="mainChildFormButton" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                                {/* Button text/icon will change based on context */}
                            </button>
                        </div>

                        <div id="childFormContainer">
                           {/* Form or display content here */}
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- TASKS TAB -->
        <section id="tasks" class="tab-content">
             <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-2">
                    {/* Add/Edit Task Form (Initially Hidden) */}
                    <div id="taskFormContainer" class="bg-white rounded-lg shadow-md p-4 mb-6 hidden">
                        <h2 id="taskFormTitle" class="text-xl font-bold mb-4 text-blue-600">Nouvelle tâche</h2>
                        <form id="taskForm">
                            <input type="hidden" id="taskIdInput">
                            <div class="mb-4">
                                <label for="taskDescriptionInput" class="block text-sm font-medium text-gray-700">Description</label>
                                <input type="text" id="taskDescriptionInput" class="${INPUT_CLASSES}" required>
                            </div>
                            <div class="mb-4">
                                <label for="taskDetailsInput" class="block text-sm font-medium text-gray-700">Détails (optionnel)</label>
                                <textarea id="taskDetailsInput" rows="3" class="${INPUT_CLASSES}"></textarea>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label for="taskAssignedParentInput" class="block text-sm font-medium text-gray-700">Assignée à</label>
                                    <select id="taskAssignedParentInput" class="${INPUT_CLASSES}">
                                        <option value="Anyone">N'importe qui</option>
                                        {/* Options will be populated by JS with parent names */}
                                    </select>
                                </div>
                                <div>
                                    <label for="taskCategoryInput" class="block text-sm font-medium text-gray-700">Catégorie</label>
                                    <select id="taskCategoryInput" class="${INPUT_CLASSES}" required>
                                        {/* Options will be populated by JS from settingsData.taskCategories */}
                                    </select>
                                </div>
                                <div>
                                    <label for="taskDueDateInput" class="block text-sm font-medium text-gray-700">Date d'échéance (optionnel)</label>
                                    <input type="date" id="taskDueDateInput" class="${INPUT_CLASSES}">
                                </div>
                            </div>
                            <div class="flex justify-end space-x-2">
                                <button type="button" id="cancelTaskFormButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">Annuler</button>
                                <button type="submit" id="saveTaskFormButton" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Enregistrer la tâche</button>
                            </div>
                        </form>
                    </div>

                    <div class="bg-white rounded-lg shadow-md p-4 mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-blue-600">Liste des tâches partagées</h2>
                            <div>
                                <button id="showNewTaskFormButton" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg">
                                    <i class="fas fa-plus mr-1"></i> Nouvelle tâche
                                </button>
                            </div>
                        </div>

                        <div class="mb-4">
                            <div class="flex space-x-2 mb-4" id="taskStatusFilters">
                                <button data-status-filter="all" class="task-filter-button bg-blue-100 text-blue-800 px-3 py-1 rounded-lg text-sm">Toutes</button>
                                <button data-status-filter="pending" class="task-filter-button bg-gray-100 text-gray-800 px-3 py-1 rounded-lg text-sm">En attente</button>
                                <button data-status-filter="completed" class="task-filter-button bg-gray-100 text-gray-800 px-3 py-1 rounded-lg text-sm">Terminées</button>
                            </div>
                            <div class="flex space-x-2 flex-wrap" id="taskCategoryFilters">
                                {/* Category filter buttons will be populated by JS */}
                            </div>
                        </div>

                        <ul id="tasksList" class="space-y-3">
                           {/* Tasks will be populated by JS */}
                           <li class="text-gray-500">Aucune tâche pour le moment.</li>
                        </ul>
                    </div>
                </div>

                <div class="md:col-span-1">
                    <div class="bg-white rounded-lg shadow-md p-4 mb-6">
                        <h2 class="text-xl font-bold mb-4 text-blue-600">Gérer les catégories</h2>
                        <ul id="taskCategoriesList" class="space-y-2">
                            {/* Categories will be populated by JS */}
                        </ul>
                        <button id="addTaskCategoryButton" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white w-full py-2 rounded-lg">
                            <i class="fas fa-plus mr-1"></i> Ajouter une catégorie
                        </button>
                    </div>

                    <div class="bg-white rounded-lg shadow-md p-4">
                        <h2 class="text-xl font-bold mb-4 text-blue-600">Statistiques des tâches</h2>
                        <div class="space-y-4">
                            <div>
                                <h3 class="font-semibold text-gray-700 mb-2">Tâches en attente: <span id="pendingTasksCount">0</span></h3>
                                <div class="w-full bg-gray-200 rounded-full h-2.5">
                                    <div id="pendingTasksBar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-700 mb-2">Tâches terminées: <span id="completedTasksCount">0</span></h3>
                                <div class="w-full bg-gray-200 rounded-full h-2.5">
                                    <div id="completedTasksBar" class="bg-green-600 h-2.5 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="bg-gray-50 p-3 rounded-lg">
                                <h3 class="font-semibold text-gray-700 mb-3">Répartition par parent</h3>
                                <canvas id="taskDistributionChart" width="400" height="200"></canvas>
                                <div class="grid grid-cols-2 mt-3 gap-2">
                                    <div class="text-center">
                                        <div id="tasksParent1Name" class="font-semibold">Parent 1</div>
                                        <div class="text-sm"><span id="tasksParent1Count">0</span> tâches</div>
                                    </div>
                                    <div class="text-center">
                                        <div id="tasksParent2Name" class="font-semibold">Parent 2</div>
                                        <div class="text-sm"><span id="tasksParent2Count">0</span> tâches</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- STATS TAB -->
        <section id="stats" class="tab-content">
             <div class="bg-white rounded-lg shadow-md p-4 mb-6">
                <h2 class="text-xl font-bold mb-4 text-blue-600">Filtres et paramètres des statistiques</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <h3 class="font-semibold mb-2">Période</h3>
                        <div class="space-y-2">
                            <div>
                                <label for="statsPeriodPreset" class="block text-sm mb-1">Préréglage</label>
                                <select id="statsPeriodPreset" class="w-full border rounded-lg p-2">
                                    <option value="lastMonth">Le dernier mois</option>
                                    <option value="last3Months">Les 3 derniers mois</option>
                                    <option value="last6Months" selected>Les 6 derniers mois</option>
                                    <option value="currentYear">L'année en cours</option>
                                    <option value="allTime">Depuis le début</option>
                                    <option value="custom">Personnalisé</option>
                                </select>
                            </div>
                            <div id="statsCustomDateRange" class="hidden space-y-2">
                                <div>
                                    <label for="statsStartDate" class="block text-sm mb-1">Du</label>
                                    <input type="date" id="statsStartDate" class="w-full border rounded-lg p-2">
                                </div>
                                <div>
                                    <label for="statsEndDate" class="block text-sm mb-1">Au</label>
                                    <input type="date" id="statsEndDate" class="w-full border rounded-lg p-2">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-semibold mb-2">Enfant(s)</h3>
                        <div id="statsChildrenFilterContainer" class="space-y-2">
                            {/* Child checkboxes will be populated here */}
                        </div>
                    </div>
                    <div>
                        <h3 class="font-semibold mb-2">Types de données à afficher</h3>
                        <div id="statsDataTypesFilterContainer" class="space-y-2">
                            <div class="flex items-center">
                                <input type="checkbox" id="statsDataTypeCustodyTime" value="custodyTime" class="mr-2" checked>
                                <label for="statsDataTypeCustodyTime">Temps de garde</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="statsDataTypeTransitions" value="transitions" class="mr-2" checked>
                                <label for="statsDataTypeTransitions">Transitions</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="statsDataTypeTasks" value="tasks" class="mr-2">
                                <label for="statsDataTypeTasks">Tâches</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-6 flex justify-between items-center">
                    <button id="applyStatsFiltersButton" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                        Appliquer les filtres
                    </button>
                    <button id="exportStatsButton" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded-lg text-sm">
                        <i class="fas fa-download mr-1"></i> Exporter les données
                    </button>
                </div>
            </div>

            <div id="statsCustodyTimeSection" class="mt-6"> {/* Hidden by default if not selected */}
                <div class="bg-white rounded-lg shadow-md p-4 mb-6">
                    <h2 class="text-xl font-bold mb-4 text-blue-600">Statistiques de garde</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="md:col-span-1 space-y-4">
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h3 class="font-semibold text-gray-700 mb-2">Répartition du temps de garde</h3>
                                <canvas id="custodyPieChart" width="300" height="300"></canvas>
                                <div class="grid grid-cols-2 mt-4 gap-4">
                                    <div class="text-center">
                                        <div id="statsParent1Percentage" class="text-xl font-bold p-2 rounded parent1-color">0%</div>
                                        <p id="statsParent1Name" class="text-sm mt-1">Parent 1</p>
                                    </div>
                                    <div class="text-center">
                                        <div id="statsParent2Percentage" class="text-xl font-bold p-2 rounded parent2-color">0%</div>
                                        <p id="statsParent2Name" class="text-sm mt-1">Parent 2</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="md:col-span-2 space-y-4">
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h3 class="font-semibold text-gray-700 mb-2">Évolution mensuelle du temps de garde</h3>
                                <canvas id="custodyMonthlyChart" width="600" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
             <div id="statsDataAnalysisSection" class="mt-6"> {/* Hidden by default if not selected */}
                <div class="bg-white rounded-lg shadow-md p-4">
                    <h2 class="text-xl font-bold mb-4 text-blue-600">Analyse des données (Garde et Transitions)</h2>
                    <ul id="statsDataAnalysisList" class="space-y-1 list-disc pl-5">
                        {/* Analysis items will be populated here */}
                        <li>Chargement des analyses...</li>
                    </ul>
                </div>
            </div>
             <div id="statsTasksSection" class="mt-6 hidden"> {/* Hidden by default */}
                 <div class="bg-white rounded-lg shadow-md p-4">
                    <h2 class="text-xl font-bold mb-4 text-blue-600">Statistiques des Tâches (Période Sélectionnée)</h2>
                    <p class="text-gray-600">Les statistiques détaillées des tâches pour la période sélectionnée seront affichées ici.</p>
                    {/* Future: Could include charts for task completion rates, distribution by category/parent over the period */}
                </div>
            </div>
        </section>

        <!-- SETTINGS TAB -->
        <section id="settings" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-1">
                    <div class="bg-white rounded-lg shadow-md p-4 mb-6">
                        <h2 class="text-xl font-bold mb-4 text-blue-600">Paramètres du compte</h2>
                        <form id="accountSettingsForm">
                            <div class="mb-4">
                                <label for="parent1NameInput" class="block text-gray-700 text-sm font-bold mb-2">Nom Parent 1</label>
                                <input type="text" id="parent1NameInput" class="${INPUT_CLASSES}">
                            </div>
                            <div class="mb-4">
                                <label for="parent2NameInput" class="block text-gray-700 text-sm font-bold mb-2">Nom Parent 2</label>
                                <input type="text" id="parent2NameInput" class="${INPUT_CLASSES}">
                            </div>
                             <!-- Email and password fields are informational for now -->
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-bold mb-2">Adresse e-mail (Parent 1)</label>
                                <input type="email" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="parent1@example.com" disabled>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-bold mb-2">Mot de passe</label>
                                <input type="password" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" value="••••••••" disabled>
                            </div>
                            <button type="button" id="saveAccountSettingsButton" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full">
                                Enregistrer les noms
                            </button>
                        </form>
                    </div>

                    <div class="bg-white rounded-lg shadow-md p-4">
                        <h2 class="text-xl font-bold mb-4 text-blue-600">Préférences d'affichage</h2>
                         <form id="displayPreferencesForm">
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-bold mb-2">
                                    Thème
                                </label>
                                <div class="flex space-x-2">
                                    <button type="button" id="themeLightButton" class="bg-white border border-gray-300 px-4 py-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <i class="fas fa-sun mr-1"></i> Clair
                                    </button>
                                    <button type="button" id="themeDarkButton" class="bg-gray-800 text-white border border-gray-300 px-4 py-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <i class="fas fa-moon mr-1"></i> Sombre
                                    </button>
                                </div>
                            </div>
                            <div class="mb-4">
                                <label for="defaultCalendarViewSelect" class="block text-gray-700 text-sm font-bold mb-2">
                                    Vue du calendrier par défaut
                                </label>
                                <select id="defaultCalendarViewSelect" class="${INPUT_CLASSES}">
                                    <option value="dayGridMonth">Mois</option>
                                    <option value="timeGridWeek">Semaine</option>
                                    <option value="listWeek">Liste Semaine</option>
                                </select>
                            </div>
                             <button type="button" id="saveDisplayPreferencesButton" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full mt-4">
                                Enregistrer les préférences
                            </button>
                        </form>
                    </div>
                </div>

                <div class="md:col-span-2">
                    <div class="bg-white rounded-lg shadow-md p-4 mb-6">
                        <h2 class="text-xl font-bold mb-4 text-blue-600">Données et sauvegarde</h2>
                        <p class="mb-4 text-gray-600">
                            Les données sont sauvegardées localement sur votre appareil. Pensez à les exporter régulièrement pour éviter toute perte.
                        </p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <button id="exportDataButton" class="bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg">
                                <i class="fas fa-download mr-1"></i> Exporter les données (JSON)
                            </button>
                            <label for="importDataInput" class="bg-green-500 hover:bg-green-600 text-white py-2 rounded-lg text-center cursor-pointer">
                                <i class="fas fa-upload mr-1"></i> Importer des données (JSON)
                            </label>
                            <input type="file" id="importDataInput" class="hidden" accept=".json">
                        </div>
                        <button id="exportCsvButton" class="mt-4 bg-teal-500 hover:bg-teal-600 text-white w-full py-2 rounded-lg">
                            <i class="fas fa-file-csv mr-1"></i> Exporter les Données Essentielles (CSV)
                        </button>
                        <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 mt-4">
                            <p class="text-sm text-yellow-700">
                                <i class="fas fa-exclamation-triangle mr-1"></i> L'importation de données remplacera toutes les données existantes. Assurez-vous de faire une sauvegarde avant d'importer.
                            </p>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow-md p-4">
                        <h2 class="text-xl font-bold mb-4 text-blue-600">Historique des modifications</h2>
                        <ul id="actionHistoryList" class="space-y-3 max-h-80 overflow-y-auto">
                           {/* Populated by JS */}
                        </ul>
                        <button id="clearActionHistoryButton" class="mt-4 bg-gray-500 hover:bg-gray-600 text-white w-full py-2 rounded-lg">
                            <i class="fas fa-trash mr-1"></i> Effacer l'historique
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="bg-gray-800 text-white py-4 mt-8 no-print">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <h3 class="text-lg font-semibold">Garde Alternée</h3>
                    <p class="text-sm text-gray-400">Application de gestion de garde alternée</p>
                </div>
                <div class="text-sm text-gray-400">
                    <p>Données sauvegardées localement sur votre appareil</p>
                    <p>Dernière mise à jour: <span id="lastUpdatedTimestamp">Jamais</span></p>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // Global variables
        let currentParent = 'Parent 1'; 
        let isDarkMode = false;
        let currentlyEditingChildId = null; 
        let miniCalendarInstance = null; 
        let fullCalendarInstance = null; 
        let mapInstance = null; 
        let currentTaskFilter = { status: 'all', categoryId: 'all' };
        let editingTaskId = null;

        let statsFilters = {
            periodPreset: 'last6Months', 
            startDate: '', 
            endDate: '', 
            selectedChildrenIds: ['all'], 
            dataTypes: ['custodyTime', 'transitions'] 
        };


        let childrenData = [];
        let scheduleData = []; 
        let transitionsData = []; 
        let tasksData = [];
        // Add a global error handler
        window.onerror = function(message, source, lineno, colno, error) {
            console.error("Global error caught:", message, "at", source, lineno, colno, error);
            // Optionally, display a message to the user
            // alert("Une erreur critique est survenue. Veuillez vérifier la console.");
            return true; // Prevents default error handling
        };

        let settingsData = {
            parent1Name: 'Parent 1',
            parent2Name: 'Parent 2',
            parent1Email: '', 
            parent2Email: '', 
            defaultTransitionTime: '18:00',
            defaultTransitionLocationId: null, 
            notificationPreferences: {
                notifyDayBefore: true,
                notifyHourBefore: true,
                requestConfirmTransition: true,
                enableEmail: false, 
                enableBrowser: false 
            },
            theme: 'light', 
            defaultCalendarView: 'dayGridMonth',
            parentsColors: {
                parent1: '#4299e1', 
                parent2: '#ed64a6'  
            },
            custodyModel: 'week-alt', 
            cycleStartDate: new Date().toISOString().split('T')[0],
            transitionLocations: [],
            taskCategories: []
        };
        let actionHistory = []; 

        // Utility for input styling
        const INPUT_CLASSES = "mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2";
        const LABEL_CLASSES = "block text-sm font-medium text-gray-700";

        async function saveData(key, data) {
            try {
                await localforage.setItem(key, data);
                console.log(`SUCCESS: Data saved for key: ${key}`, data);
                 document.getElementById('lastUpdatedTimestamp').textContent = new Date().toLocaleString('fr-FR');
                 localStorage.setItem('lastSaveTimestamp', new Date().toLocaleString('fr-FR')); // Persist for next session
            } catch (err) {
                console.error(`FAILURE: Error saving data for key ${key}:`, err);
                alert(`Failed to save data for ${key}. Check console.`);
            }
        }

        async function loadData(key, defaultValue = []) {
            try {
                const value = await localforage.getItem(key);
                if (value !== null) {
                    console.log(`SUCCESS: Data loaded for key: ${key}`, value);
                } else {
                    console.log(`INFO: No data found for key: ${key}, using default value.`, defaultValue);
                }
                if (value === null && key === 'settingsData') { 
                     console.log(`No settings found, using default settings for key: ${key}`);
                     const defaultSettings = JSON.parse(JSON.stringify(defaultValue));
                     if (!Array.isArray(defaultSettings.taskCategories)) {
                         defaultSettings.taskCategories = [];
                     }
                      if (!Array.isArray(defaultSettings.transitionLocations)) {
                        defaultSettings.transitionLocations = [];
                    }
                     return defaultSettings;
                }
                if (value === null) {
                    if ( (key === 'childrenData' || key === 'scheduleData' || key === 'transitionsData' || key === 'actionHistory' || key === 'tasksData') && Array.isArray(defaultValue) && defaultValue.length === 0) { 
                        return [];
                    }
                    console.log(`INFO: No data found for key: ${key}, using default value.`);
                    return defaultValue;
                }
                // console.log(`Data loaded for key: ${key}`); // Redundant with the one above
                if (key === 'settingsData' && value && !Array.isArray(value.taskCategories)) {
                    console.warn(`Loaded settingsData for ${key} had non-array taskCategories. Initializing to [].`);
                    value.taskCategories = [];
                }
                if (key === 'settingsData' && value && !Array.isArray(value.transitionLocations)) {
                    console.warn(`Loaded settingsData for ${key} had non-array transitionLocations. Initializing to [].`);
                    value.transitionLocations = [];
                }
                return value;
            } catch (err) {
                console.error(`FAILURE: Error loading data for key ${key}:`, err);
                alert(`Failed to load data for ${key}. Check console.`);
                return defaultValue; 
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            initializeCalendars(); 
            initializeCharts(); 
            refreshTransitionMap(); 
            setupEventListeners(); 
            setupCalendarEventListeners(); 
            setupTransitionEventListeners(); 
            setupTaskEventListeners(); 
            setupSettingsEventListeners(); 
            setupStatsEventListeners(); 

            loadSavedData().then(() => {
                updateGlobalParentNameDisplays(); // Ensure names are set everywhere after load
                populateStatsFilters();
                renderChildrenList(); // Ensure children list is rendered for its tab
                renderDashboard(); 
                 if(document.getElementById('stats').classList.contains('active')) { 
                    renderStatistics();
                }
                if(document.getElementById('settings').classList.contains('active')) {
                    populateAccountSettingsForm();
                    populateDisplayPreferencesForm();
                    renderActionHistory();
                }
                document.getElementById('lastUpdatedTimestamp').textContent = localStorage.getItem('lastSaveTimestamp') || 'Jamais';
                console.log("initializeApp: Initial data loaded and rendering triggered.");
            }).catch(err => {
                console.error("Error during loadSavedData.then() chain:", err);
            });

            // Ensure core button listeners are robustly set
            const mainTabs = document.getElementById('mainTabs');
            if (mainTabs) {
                mainTabs.addEventListener('click', function(event) {
                    const button = event.target.closest('.tab-button');
                    if (button && button.dataset.tab) {
                        switchTab(button.dataset.tab);
                    }
                });
                console.log("initializeApp: Main tabs event listener attached.");
            } else {
                console.error("initializeApp: Main tabs element not found!");
            }

            const parentToggleButton = document.querySelector('button[onclick="toggleParent()"]');
            if (parentToggleButton) {
                parentToggleButton.addEventListener('click', toggleParent);
                 // Remove onclick to avoid double call if it was already there
                parentToggleButton.removeAttribute('onclick');
                console.log("initializeApp: Parent toggle button event listener attached.");
            } else {
                 console.error("initializeApp: Parent toggle button not found!");
            }
             console.log("initializeApp: Completed.");
        }
        function renderDashboard() {
            renderDashboardNextTransition(); 
            refreshCalendars(); 
            renderDashboardTasks(); 
            renderDashboardChildrenList(); 
            renderDashboardCustodyChart(); 
            console.log('Dashboard refreshed');
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active', 'bg-blue-800'));
            
            const newActiveTab = document.getElementById(tabId);
            if (newActiveTab) newActiveTab.classList.add('active');
            
            const newActiveButton = document.querySelector(`.tab-button[data-tab="${tabId}"]`);
            if (newActiveButton) newActiveButton.classList.add('active', 'bg-blue-800');
            
            if (tabId === 'calendar' && fullCalendarInstance) {
                fullCalendarInstance.render(); 
            }
            if (tabId === 'dashboard') { 
                renderDashboard();
                 if (miniCalendarInstance) miniCalendarInstance.render(); 
            }
             if (tabId === 'transitions' && mapInstance) {
                setTimeout(() => { if(mapInstance) mapInstance.invalidateSize() }, 0); 
            }
            if (tabId === 'tasks') {
                renderTasks(currentTaskFilter); 
                renderTaskCategories(); 
            }
            if (tabId === 'stats') {
                populateStatsFilters(); 
                renderStatistics();
            }
            if (tabId === 'settings') {
                populateAccountSettingsForm();
                populateDisplayPreferencesForm();
                renderActionHistory();
            }
        }

        function toggleParent() {
            const oldCurrentParent = document.getElementById('currentParent').textContent;
            if (oldCurrentParent === settingsData.parent1Name) {
                currentParent = settingsData.parent2Name;
            } else if (oldCurrentParent === settingsData.parent2Name) {
                 currentParent = settingsData.parent1Name;
            } else { // Fallback if currentParent is not one of the saved names
                currentParent = settingsData.parent1Name;
            }
            document.getElementById('currentParent').textContent = currentParent;
            updateGlobalParentNameDisplays(); // This will ensure consistency everywhere
        }

        function updateGlobalParentNameDisplays() { 
            const p1Name = settingsData.parent1Name;
            const p2Name = settingsData.parent2Name;

            const currentParentEl = document.getElementById('currentParent');
            if (currentParentEl.textContent !== p1Name && currentParentEl.textContent !== p2Name) {
                 currentParentEl.textContent = p1Name; // Default to P1 if current is out of sync
                 currentParent = p1Name;
            } else {
                 currentParent = currentParentEl.textContent; // Ensure global var is also updated
            }
            
            document.getElementById('dashboardParent1Name').textContent = p1Name;
            document.getElementById('dashboardParent2Name').textContent = p2Name;
            if (window.dashboardCustodyChart) {
                window.dashboardCustodyChart.data.labels = [p1Name, p2Name];
                window.dashboardCustodyChart.data.datasets[0].backgroundColor = [settingsData.parentsColors.parent1, settingsData.parentsColors.parent2];
                window.dashboardCustodyChart.update();
            }
            document.getElementById('tasksParent1Name').textContent = p1Name;
            document.getElementById('tasksParent2Name').textContent = p2Name;
            const taskAssignedParentEl = document.getElementById('taskAssignedParentInput');
            if (taskAssignedParentEl) {
                const currentVal = taskAssignedParentEl.value;
                taskAssignedParentEl.innerHTML = '<option value="Anyone">N\'importe qui</option>';
                const p1Opt = document.createElement('option'); p1Opt.value = p1Name; p1Opt.textContent = p1Name; taskAssignedParentEl.appendChild(p1Opt);
                const p2Opt = document.createElement('option'); p2Opt.value = p2Name; p2Opt.textContent = p2Name; taskAssignedParentEl.appendChild(p2Opt);
                if (currentVal === p1Name || currentVal === p2Name || currentVal === "Anyone") taskAssignedParentEl.value = currentVal;
                else taskAssignedParentEl.value = "Anyone";
            }
             if(window.taskDistributionChartInstance) {
                window.taskDistributionChartInstance.data.labels = [p1Name, p2Name, 'N\'importe qui'];
                window.taskDistributionChartInstance.data.datasets[0].backgroundColor = [settingsData.parentsColors.parent1, settingsData.parentsColors.parent2, '#cbd5e1'];
                window.taskDistributionChartInstance.update();
            }

            document.getElementById('statsParent1Name').textContent = p1Name;
            document.getElementById('statsParent2Name').textContent = p2Name;
            if(window.statsCustodyPieChart) {
                window.statsCustodyPieChart.data.labels = [p1Name, p2Name];
                 window.statsCustodyPieChart.data.datasets[0].backgroundColor = [settingsData.parentsColors.parent1, settingsData.parentsColors.parent2];
                window.statsCustodyPieChart.update();
            }
             if(window.statsCustodyMonthlyChart) {
                if(window.statsCustodyMonthlyChart.data.datasets[0]) {
                    window.statsCustodyMonthlyChart.data.datasets[0].label = p1Name;
                    window.statsCustodyMonthlyChart.data.datasets[0].backgroundColor = settingsData.parentsColors.parent1;
                }
                if(window.statsCustodyMonthlyChart.data.datasets[1]) {
                    window.statsCustodyMonthlyChart.data.datasets[1].label = p2Name;
                    window.statsCustodyMonthlyChart.data.datasets[1].backgroundColor = settingsData.parentsColors.parent2;
                }
                window.statsCustodyMonthlyChart.update();
            }
            
            const exceptionParent1Btn = document.getElementById('exceptionParent1Button');
            const exceptionParent2Btn = document.getElementById('exceptionParent2Button');
            if(exceptionParent1Btn) exceptionParent1Btn.textContent = p1Name;
            if(exceptionParent2Btn) exceptionParent2Btn.textContent = p2Name;
            
            // Re-render dynamic content that might include parent names
            refreshCalendars(); 
            renderTransitions(); 
            renderTasks(currentTaskFilter); 
            renderDashboard(); // To update dashboard items that might use parent names in titles
            console.log("Global parent name displays updated.");
        }


        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode', isDarkMode);
            settingsData.theme = isDarkMode ? 'dark' : 'light';
            // Save theme preference directly
            saveData('settingsData', settingsData).then(() => {
                 console.log("Theme preference saved:", settingsData.theme);
                 // Update theme button active state
                if (settingsData.theme === 'dark') {
                    document.getElementById('themeDarkButton').classList.add('ring-2', 'ring-offset-2', 'ring-indigo-500');
                    document.getElementById('themeLightButton').classList.remove('ring-2', 'ring-offset-2', 'ring-indigo-500');
                } else {
                    document.getElementById('themeLightButton').classList.add('ring-2', 'ring-offset-2', 'ring-indigo-500');
                    document.getElementById('themeDarkButton').classList.remove('ring-2', 'ring-offset-2', 'ring-indigo-500');
                }
            }); 
            const icon = document.querySelector('#darkModeToggle i');
            icon.classList.toggle('fa-moon', !isDarkMode);
            icon.classList.toggle('fa-sun', isDarkMode);
            refreshCalendars(); 
        }
        
        function calculateAge(dobString) {
            if (!dobString) return '';
            const dob = new Date(dobString);
            const today = new Date();
            let age = today.getFullYear() - dob.getFullYear();
            const m = today.getMonth() - dob.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) age--;
            return age;
        }

        function renderChildrenList() {
            const childrenListEl = document.getElementById('childrenList');
            if (!childrenListEl) return;
            childrenListEl.innerHTML = ''; 

            if (childrenData && childrenData.length > 0) {
                childrenData.forEach(child => {
                    const age = calculateAge(child.dob);
                    const li = document.createElement('li');
                    const isCurrentlyInEditForm = document.getElementById('childFormContainer').innerHTML.includes('childNameInput');
                    li.className = `p-3 rounded-lg border-l-4 cursor-pointer ${currentlyEditingChildId === child.id && isCurrentlyInEditForm ? 'bg-yellow-50 border-yellow-500' : (currentlyEditingChildId === child.id ? 'bg-blue-50 border-blue-500' : 'bg-gray-50 border-gray-300')}`;
                    li.setAttribute('onclick', `showChildProfile('${child.id}')`);
                    li.innerHTML = `<h3 class="font-semibold">${child.name}</h3><p class="text-sm text-gray-600">${age} ans</p>`;
                    childrenListEl.appendChild(li);
                });
            }
            const addLi = document.createElement('li');
            addLi.className = 'p-3 border border-dashed border-gray-300 rounded-lg text-center cursor-pointer hover:bg-gray-100';
            addLi.setAttribute('onclick', 'prepareAddChildForm()');
            addLi.innerHTML = `<i class="fas fa-plus text-gray-500"></i><p class="text-sm text-gray-500">Ajouter un enfant</p>`;
            childrenListEl.appendChild(addLi);
        }

        function getChildFormHTML(child = {}) {
            const isEditingExisting = !!(child && child.id); 

            let medicalInfoHTML = '';
            if (isEditingExisting) {
                child.medicalInfo = child.medicalInfo || []; 
                medicalInfoHTML = child.medicalInfo.map((info, index) => `
                    <div class="medical-item-form-group mb-2 p-2 border rounded-md" data-id="${info.id || 'temp-med-' + index}">
                        <div class="flex justify-between items-center mb-1">
                            <label class="block text-sm font-medium text-gray-700">Type</label>
                            <button type="button" onclick="removeMedicalInfoFromForm(this.closest('.medical-item-form-group').dataset.id)" class="text-red-500 hover:text-red-700 text-xs"><i class="fas fa-trash-alt"></i></button>
                        </div>
                        <select class="medical-info-type w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-1 mb-1">
                            <option value="allergy" ${info.type === 'allergy' ? 'selected' : ''}>Allergie</option>
                            <option value="condition" ${info.type === 'condition' ? 'selected' : ''}>Condition Médicale</option>
                            <option value="note" ${info.type === 'note' ? 'selected' : ''}>Note Médicale</option>
                        </select>
                        <label class="block text-sm font-medium text-gray-700">Description</label>
                        <input type="text" class="medical-info-text w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-1" value="${info.text || ''}">
                    </div>
                `).join('');
            }

            let activitiesHTML = '';
            if (isEditingExisting) {
                child.activities = child.activities || [];
                activitiesHTML = child.activities.map((activity, index) => `
                    <div class="activity-item-form-group mb-2 p-2 border rounded-md" data-id="${activity.id || 'temp-act-' + index}">
                         <div class="flex justify-between items-center mb-1">
                            <label class="block text-sm font-medium text-gray-700">Nom de l'activité</label>
                            <button type="button" onclick="removeActivityFromForm(this.closest('.activity-item-form-group').dataset.id)" class="text-red-500 hover:text-red-700 text-xs"><i class="fas fa-trash-alt"></i></button>
                        </div>
                        <input type="text" class="activity-info-name w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-1 mb-1" value="${activity.name || ''}">
                        <label class="block text-sm font-medium text-gray-700">Horaire</label>
                        <input type="text" class="activity-info-schedule w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-1 mb-1" value="${activity.schedule || ''}">
                        <label class="block text-sm font-medium text-gray-700">Lieu</label>
                        <input type="text" class="activity-info-location w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-1" value="${activity.location || ''}">
                    </div>
                `).join('');
            }
            
            const detailsMessage = !isEditingExisting ? '<p class="text-sm text-gray-600">Les sections Informations Médicales et Activités seront disponibles après la sauvegarde initiale de l\'enfant.</p>' : '';

            return `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6">
                    <div>
                        <h3 class="text-lg font-semibold mb-3 text-blue-600">Informations générales</h3>
                        <div class="space-y-3">
                            <div><label for="childNameInput" class="${LABEL_CLASSES}">Nom complet</label><input type="text" id="childNameInput" value="${child.name || ''}" class="${INPUT_CLASSES}"></div>
                            <div><label for="childDobInput" class="${LABEL_CLASSES}">Date de naissance</label><input type="date" id="childDobInput" value="${child.dob || ''}" class="${INPUT_CLASSES}"></div>
                            <div><label for="childSchoolInput" class="${LABEL_CLASSES}">École</label><input type="text" id="childSchoolInput" value="${child.school || ''}" class="${INPUT_CLASSES}"></div>
                            <div><label for="childClassInput" class="${LABEL_CLASSES}">Classe</label><input type="text" id="childClassInput" value="${child.class || ''}" class="${INPUT_CLASSES}"></div>
                        </div>
                        <h3 class="text-lg font-semibold mb-3 mt-6 text-blue-600">Notes Générales</h3>
                        <textarea id="childNotesInput" rows="3" class="${INPUT_CLASSES} w-full">${child.notes || ''}</textarea>
                    </div>
                    <div>
                        ${detailsMessage}
                        <div id="childMedicalFormArea" class="mt-0 md:mt-6 ${isEditingExisting ? '' : 'hidden'}">
                             <h3 class="text-lg font-semibold mb-3 text-blue-600">Informations Médicales</h3>
                             <div id="childMedicalFormAreaRenderedList" class="space-y-2">${medicalInfoHTML}</div>
                             <button type="button" onclick="addMedicalInfoToForm()" class="mt-2 text-blue-500 hover:text-blue-700 text-sm"><i class="fas fa-plus mr-1"></i> Ajouter Info Médicale</button>
                        </div>
                        <div id="childActivitiesFormArea" class="mt-6 ${isEditingExisting ? '' : 'hidden'}">
                             <h3 class="text-lg font-semibold mb-3 text-blue-600">Activités</h3>
                             <div id="childActivitiesFormAreaRenderedList" class="space-y-2">${activitiesHTML}</div>
                             <button type="button" onclick="addActivityToForm()" class="mt-2 text-blue-500 hover:text-blue-700 text-sm"><i class="fas fa-plus mr-1"></i> Ajouter Activité</button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function getChildDisplayHTML(child) {
             if (!child) return '<p>Aucun enfant sélectionné.</p>';
             const age = calculateAge(child.dob);
             const medicalItemsHTML = child.medicalInfo && child.medicalInfo.length > 0 ?
                child.medicalInfo.map(info => `
                    <li class="flex items-center justify-between p-2 hover:bg-gray-50 rounded-md group">
                        <div><i class="fas ${info.type === 'allergy' ? 'fa-exclamation-triangle text-red-500' : (info.type === 'condition' ? 'fa-notes-medical text-yellow-500' : 'fa-info-circle text-blue-500')} mr-2"></i><span>${info.text}</span></div>
                        <button onclick="deleteChildMedicalItem('${child.id}', '${info.id}')" class="text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity text-xs"><i class="fas fa-trash"></i></button>
                    </li>`).join('') : 
                '<li class="text-sm text-gray-500">Aucune information médicale.</li>';

            const activityItemsHTML = child.activities && child.activities.length > 0 ?
                child.activities.map(act => `
                <li class="bg-indigo-50 p-3 rounded-lg group">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-semibold">${act.name}</h4>
                            <p class="text-sm text-gray-600">${act.schedule || ''}</p>
                            <p class="text-sm text-gray-600">${act.location || ''}</p>
                        </div>
                        <button onclick="deleteChildActivityItem('${child.id}', '${act.id}')" class="text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity text-xs ml-2"><i class="fas fa-trash"></i></button>
                    </div>
                </li>`).join('') :
                '<li class="text-sm text-gray-500">Aucune activité.</li>';

             return `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6">
                    <div>
                        <h3 class="text-lg font-semibold mb-3 text-blue-600">Informations générales</h3>
                        <div id="childGeneralInfoDisplay" class="space-y-2">
                            <div class="flex"><span class="font-semibold w-40">Date de naissance:</span><span>${child.dob ? new Date(child.dob).toLocaleDateString('fr-FR') : 'N/A'}</span></div>
                            <div class="flex"><span class="font-semibold w-40">Âge:</span><span>${age ? age + ' ans' : 'N/A'}</span></div>
                            <div class="flex"><span class="font-semibold w-40">École:</span><span>${child.school || 'N/A'}</span></div>
                            <div class="flex"><span class="font-semibold w-40">Classe:</span><span>${child.class || 'N/A'}</span></div>
                        </div>

                        <h3 class="text-lg font-semibold mb-3 mt-6 text-blue-600">Informations médicales</h3>
                        <ul id="childMedicalInfoListDisplay" class="space-y-1">${medicalItemsHTML}</ul>
                        <div class="mt-3">
                            <button onclick="prepareEditChildForm('${child.id}', 'medical')" class="text-blue-500 hover:text-blue-700 text-sm"><i class="fas fa-edit mr-1"></i> Gérer infos médicales</button>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-3 text-blue-600">Activités</h3>
                        <ul id="childActivitiesListDisplay" class="space-y-3">${activityItemsHTML}</ul>
                        <div class="mt-3">
                             <button onclick="prepareEditChildForm('${child.id}', 'activities')" class="text-blue-500 hover:text-blue-700 text-sm"><i class="fas fa-edit mr-1"></i> Gérer activités</button>
                        </div>

                        <h3 class="text-lg font-semibold mb-3 mt-6 text-blue-600">Notes Générales</h3>
                        <div class="bg-yellow-50 p-3 rounded-lg">
                            <p class="text-sm">${child.notes || 'Aucune note.'}</p>
                        </div>
                    </div>
                </div>`;
        }

        function showChildProfile(childId) {
            currentlyEditingChildId = childId; 
            const child = childrenData.find(c => c.id === childId);
            
            const profileTitleEl = document.getElementById('childProfileTitle');
            const formContainerEl = document.getElementById('childFormContainer');
            const mainButtonEl = document.getElementById('mainChildFormButton');

            if (child) {
                profileTitleEl.textContent = child.name;
                formContainerEl.innerHTML = getChildDisplayHTML(child);
                mainButtonEl.innerHTML = '<i class="fas fa-pen mr-1"></i> Modifier Profil Complet';
                mainButtonEl.onclick = () => prepareEditChildForm(childId);
            } else {
                profileTitleEl.textContent = 'Sélectionnez un enfant';
                formContainerEl.innerHTML = '<p class="text-gray-500">Sélectionnez un enfant dans la liste ou ajoutez-en un nouveau.</p>';
                mainButtonEl.innerHTML = '<i class="fas fa-plus mr-1"></i> Ajouter un enfant';
                mainButtonEl.onclick = () => prepareAddChildForm();
            }
            renderChildrenList(); 
        }
        
        function prepareAddChildForm() {
            currentlyEditingChildId = null; 
            document.getElementById('childProfileTitle').textContent = 'Ajouter un nouvel enfant';
            document.getElementById('childFormContainer').innerHTML = getChildFormHTML(); 
            const mainButtonEl = document.getElementById('mainChildFormButton');
            mainButtonEl.innerHTML = '<i class="fas fa-save mr-1"></i> Sauvegarder Enfant';
            mainButtonEl.onclick = () => saveChildForm();
            renderChildrenList();
        }

        function prepareEditChildForm(childId, section = null) {
            const child = childrenData.find(c => c.id === childId);
            if (!child) return;

            currentlyEditingChildId = childId;
            document.getElementById('childProfileTitle').textContent = `Modifier : ${child.name}`;
            document.getElementById('childFormContainer').innerHTML = getChildFormHTML(child); 
            
            const mainButtonEl = document.getElementById('mainChildFormButton');
            mainButtonEl.innerHTML = '<i class="fas fa-save mr-1"></i> Sauvegarder Modifications';
            mainButtonEl.onclick = () => saveChildForm();
            
            renderChildrenList(); 

            if (section) {
                let sectionEl;
                if (section === 'medical') sectionEl = document.getElementById('childMedicalFormArea');
                else if (section === 'activities') sectionEl = document.getElementById('childActivitiesFormArea');
                else if (section === 'notes') sectionEl = document.getElementById('childNotesInput');
                
                if (sectionEl) {
                    sectionEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    if (sectionEl.tagName === 'TEXTAREA' || sectionEl.tagName === 'INPUT') {
                        sectionEl.focus();
                    } else if (sectionEl.id === 'childMedicalFormArea' || sectionEl.id === 'childActivitiesFormArea') {
                        const firstInput = sectionEl.querySelector('input, select, textarea');
                        if (firstInput) firstInput.focus();
                    }
                }
            }
        }
        
        function addMedicalInfoToForm() {
            const container = document.getElementById('childMedicalFormAreaRenderedList');
            if (!container) return;
            const tempId = `temp-med-${Date.now()}`;
            const div = document.createElement('div');
            div.className = 'medical-item-form-group mb-2 p-2 border rounded-md';
            div.dataset.id = tempId; 
            div.innerHTML = `
                <div class="flex justify-between items-center mb-1">
                    <label class="block text-sm font-medium text-gray-700">Type</label>
                    <button type="button" onclick="removeMedicalInfoFromForm('${tempId}')" class="text-red-500 hover:text-red-700 text-xs"><i class="fas fa-trash-alt"></i></button>
                </div>
                <select class="medical-info-type w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-1 mb-1">
                    <option value="allergy">Allergie</option>
                    <option value="condition">Condition Médicale</option>
                    <option value="note" selected>Note Médicale</option>
                </select>
                <label class="block text-sm font-medium text-gray-700">Description</label>
                <input type="text" class="medical-info-text w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-1" value="">
            `;
            container.appendChild(div);
        }

        function removeMedicalInfoFromForm(elementDataId) { 
            const itemElement = document.querySelector(`.medical-item-form-group[data-id="${elementDataId}"]`);
            if (itemElement) {
                itemElement.remove();
            }
        }
        
        async function deleteChildMedicalItem(childId, medicalItemId) {
            const childIndex = childrenData.findIndex(c => c.id === childId);
            if (childIndex > -1) {
                childrenData[childIndex].medicalInfo = childrenData[childIndex].medicalInfo || [];
                const medicalInfoIndex = childrenData[childIndex].medicalInfo.findIndex(m => m.id === medicalItemId);
                if (medicalInfoIndex > -1) {
                    const removedItem = childrenData[childIndex].medicalInfo.splice(medicalInfoIndex, 1);
                    await saveData('childrenData', childrenData);
                    showChildProfile(childId); 
                    actionHistory.push({ timestamp: new Date().toISOString(), user: document.getElementById('currentParent').textContent, action: 'Suppression info médicale', details: `Enfant: ${childrenData[childIndex].name}, Info: ${removedItem[0].text}` });
                    await saveData('actionHistory', actionHistory);
                }
            }
        }

        function addActivityToForm() {
            const container = document.getElementById('childActivitiesFormAreaRenderedList');
            if (!container) return;
            const tempId = `temp-act-${Date.now()}`;
            const div = document.createElement('div');
            div.className = 'activity-item-form-group mb-2 p-2 border rounded-md';
            div.dataset.id = tempId;
            div.innerHTML = `
                <div class="flex justify-between items-center mb-1">
                    <label class="block text-sm font-medium text-gray-700">Nom de l'activité</label>
                    <button type="button" onclick="removeActivityFromForm('${tempId}')" class="text-red-500 hover:text-red-700 text-xs"><i class="fas fa-trash-alt"></i></button>
                </div>
                <input type="text" class="activity-info-name w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-1 mb-1" value="">
                <label class="block text-sm font-medium text-gray-700">Horaire</label>
                <input type="text" class="activity-info-schedule w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-1 mb-1" value="">
                <label class="block text-sm font-medium text-gray-700">Lieu</label>
                <input type="text" class="activity-info-location w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-1" value="">
            `;
            container.appendChild(div);
        }

        function removeActivityFromForm(elementDataId) {
            const itemElement = document.querySelector(`.activity-item-form-group[data-id="${elementDataId}"]`);
            if (itemElement) {
                itemElement.remove();
            }
        }

        async function deleteChildActivityItem(childId, activityItemId) {
            const childIndex = childrenData.findIndex(c => c.id === childId);
            if (childIndex > -1) {
                childrenData[childIndex].activities = childrenData[childIndex].activities || [];
                const activityIndex = childrenData[childIndex].activities.findIndex(a => a.id === activityItemId);
                if (activityIndex > -1) {
                    const removedItem = childrenData[childIndex].activities.splice(activityIndex, 1);
                    await saveData('childrenData', childrenData);
                    showChildProfile(childId);
                    actionHistory.push({ timestamp: new Date().toISOString(), user: document.getElementById('currentParent').textContent, action: 'Suppression activité', details: `Enfant: ${childrenData[childIndex].name}, Activité: ${removedItem[0].name}` });
                    await saveData('actionHistory', actionHistory);
                }
            }
        }


        async function saveChildForm() {
            const name = document.getElementById('childNameInput').value.trim();
            if (!name) {
                alert("Le nom de l'enfant est requis.");
                return;
            }
            const dob = document.getElementById('childDobInput').value;
            const school = document.getElementById('childSchoolInput').value.trim();
            const childClassValue = document.getElementById('childClassInput').value.trim();
            const notes = document.getElementById('childNotesInput').value.trim();
            const currentUser = document.getElementById('currentParent').textContent || 'Utilisateur inconnu';
            let savedChildId = currentlyEditingChildId;

            const medicalInfoItems = [];
            const medicalFormGroups = document.querySelectorAll('#childMedicalFormAreaRenderedList .medical-item-form-group');
            medicalFormGroups.forEach(group => {
                const text = group.querySelector('.medical-info-text').value.trim();
                const type = group.querySelector('.medical-info-type').value;
                const existingId = group.dataset.id.startsWith('temp-med-') ? null : group.dataset.id;
                if (text) { 
                    medicalInfoItems.push({ id: existingId || `med-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`, text, type });
                }
            });
            
            const activitiesItems = [];
            const activityFormGroups = document.querySelectorAll('#childActivitiesFormAreaRenderedList .activity-item-form-group');
            activityFormGroups.forEach(group => {
                const actName = group.querySelector('.activity-info-name').value.trim();
                const schedule = group.querySelector('.activity-info-schedule').value.trim();
                const location = group.querySelector('.activity-info-location').value.trim();
                const existingId = group.dataset.id.startsWith('temp-act-') ? null : group.dataset.id;
                if (actName) { 
                    activitiesItems.push({ id: existingId || `act-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`, name: actName, schedule, location });
                }
            });

            if (currentlyEditingChildId === null) { 
                const newChild = {
                    id: Date.now().toString(), name, dob, school, class: childClassValue, 
                    medicalInfo: medicalInfoItems, activities: activitiesItems, notes
                };
                childrenData.push(newChild);
                actionHistory.push({ timestamp: new Date().toISOString(), user: currentUser, action: 'Ajout enfant', details: newChild.name });
                savedChildId = newChild.id; 
            } else { 
                const childIndex = childrenData.findIndex(c => c.id === currentlyEditingChildId);
                if (childIndex > -1) {
                    childrenData[childIndex] = {
                        ...childrenData[childIndex], 
                        name, dob, school, class: childClassValue, notes,
                        medicalInfo: medicalInfoItems,
                        activities: activitiesItems 
                    };
                    actionHistory.push({ timestamp: new Date().toISOString(), user: currentUser, action: 'Modification profil enfant', details: childrenData[childIndex].name });
                } else {
                    console.error("Child not found for editing:", currentlyEditingChildId);
                    return; 
                }
            }

            await saveData('childrenData', childrenData);
            await saveData('actionHistory', actionHistory);
            
            renderDashboard(); 
        }


        function initializeCalendars() { 
            const miniCalendarEl = document.getElementById('miniCalendar');
            if (miniCalendarEl && typeof FullCalendar !== 'undefined') { 
                miniCalendarInstance = new FullCalendar.Calendar(miniCalendarEl, { 
                    initialView: 'dayGridMonth',
                    headerToolbar: { left: 'prev,next', center: 'title', right: '' },
                    height: 'auto',
                    locale: 'fr',
                });
                miniCalendarInstance.render();
            }
            const fullCalendarEl = document.getElementById('fullCalendar');
            if (fullCalendarEl && typeof FullCalendar !== 'undefined') { 
                fullCalendarInstance = new FullCalendar.Calendar(fullCalendarEl, { 
                    initialView: settingsData.defaultCalendarView,
                    headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,listWeek' },
                    height: 'auto', 
                    locale: 'fr',
                    eventClick: function(info) {
                        let details = `Événement: ${info.event.title}\nDébut: ${info.event.start ? info.event.start.toLocaleString('fr-FR') : 'N/A'}`;
                        if (info.event.end) {
                            details += `\nFin: ${info.event.end.toLocaleString('fr-FR')}`;
                        }
                        if (info.event.allDay) {
                            details += `\n(Journée entière)`;
                        }
                        if (info.event.extendedProps.reason) {
                            details += `\nRaison: ${info.event.extendedProps.reason}`;
                        }
                        if (info.event.extendedProps.isException) {
                            details += `\n(Exception)`;
                        }
                         if (info.event.extendedProps.generated) {
                            details += `\n(Généré automatiquement)`;
                        }
                        alert(details);
                    }
                });
                fullCalendarInstance.render();
            }
        }
        
        function refreshCalendars() {
            let eventsToDisplay = [];
            if (scheduleData && Array.isArray(scheduleData) && scheduleData.length > 0) {
                 eventsToDisplay = scheduleData.map(event => ({
                    id: event.id || `event-${Date.now()}-${Math.random()}`, 
                    title: event.title,
                    start: event.start,
                    end: event.end, 
                    color: event.color,
                    allDay: event.allDay !== undefined ? event.allDay : true, 
                    extendedProps: {
                        isException: event.isException || false,
                        reason: event.reason || '',
                        generated: event.generated || false 
                    }
                }));
            }
            
            if (miniCalendarInstance) {
                miniCalendarInstance.getEventSources().forEach(source => source.remove());
                miniCalendarInstance.addEventSource(eventsToDisplay);
            }
            if (fullCalendarInstance) {
                fullCalendarInstance.getEventSources().forEach(source => source.remove());
                fullCalendarInstance.addEventSource(eventsToDisplay);
            }
            console.log("Calendars refreshed. Events displayed:", eventsToDisplay.length);
        }
        
        function initializeCharts() {
            const custodyChartEl = document.getElementById('custodyChart');
            if (custodyChartEl && typeof Chart !== 'undefined') {
                if (window.dashboardCustodyChart instanceof Chart) {
                    window.dashboardCustodyChart.destroy();
                }
                window.dashboardCustodyChart = new Chart(custodyChartEl, {
                    type: 'doughnut',
                    data: {
                        labels: [settingsData.parent1Name, settingsData.parent2Name],
                        datasets: [{
                            data: [50, 50], 
                            backgroundColor: [settingsData.parentsColors.parent1, settingsData.parentsColors.parent2],
                            hoverOffset: 4
                        }]
                    },
                    options: { responsive: true, plugins: { legend: { display: false } } }
                });
            }

            const taskDistributionChartEl = document.getElementById('taskDistributionChart');
            if (taskDistributionChartEl && typeof Chart !== 'undefined') {
                 if (window.taskDistributionChartInstance instanceof Chart) {
                    window.taskDistributionChartInstance.destroy();
                }
                window.taskDistributionChartInstance = new Chart(taskDistributionChartEl, {
                    type: 'pie',
                    data: {
                        labels: [settingsData.parent1Name, settingsData.parent2Name, 'N\'importe qui'],
                        datasets: [{
                            data: [0,0,0], 
                            backgroundColor: [settingsData.parentsColors.parent1, settingsData.parentsColors.parent2, '#cbd5e1'], 
                            hoverOffset: 4
                        }]
                    },
                    options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
                });
            }

            const custodyPieChartEl = document.getElementById('custodyPieChart');
            if (custodyPieChartEl && typeof Chart !== 'undefined') {
                 if (window.statsCustodyPieChart instanceof Chart) {
                    window.statsCustodyPieChart.destroy();
                }
                window.statsCustodyPieChart = new Chart(custodyPieChartEl, {
                    type: 'pie',
                    data: {
                        labels: [settingsData.parent1Name, settingsData.parent2Name],
                        datasets: [{
                            data: [50, 50], 
                            backgroundColor: [settingsData.parentsColors.parent1, settingsData.parentsColors.parent2],
                            hoverOffset: 4
                        }]
                    },
                    options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
                });
            }

            const custodyMonthlyChartEl = document.getElementById('custodyMonthlyChart');
            if (custodyMonthlyChartEl && typeof Chart !== 'undefined') {
                if (window.statsCustodyMonthlyChart instanceof Chart) {
                    window.statsCustodyMonthlyChart.destroy();
                }
                window.statsCustodyMonthlyChart = new Chart(custodyMonthlyChartEl, {
                    type: 'bar',
                    data: {
                        labels: ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin'], 
                        datasets: [
                            { label: settingsData.parent1Name, data: [0,0,0,0,0,0], backgroundColor: settingsData.parentsColors.parent1 },
                            { label: settingsData.parent2Name, data: [0,0,0,0,0,0], backgroundColor: settingsData.parentsColors.parent2 }
                        ]
                    },
                    options: { responsive: true, plugins: { legend: { position: 'top', } }, scales: { x: { stacked: true, }, y: { stacked: true, min: 0, max: 100, ticks: { callback: function(value) { return value + '%'; } } } } }
                });
            }
        }

        function renderDashboardCustodyChart() {
            if (!window.dashboardCustodyChart) {
                console.log("Dashboard custody chart instance not found.");
                return;
            }

            let parent1Days = 0;
            let parent2Days = 0;
            const oneDay = 24 * 60 * 60 * 1000; 

            scheduleData.forEach(event => {
                if (!event.start || !event.end || !event.allDay) return; 

                const startDate = new Date(event.start + "T00:00:00");
                const endDate = new Date(event.end + "T00:00:00");
                const durationDays = Math.round(Math.abs((endDate - startDate) / oneDay));

                if (event.title === settingsData.parent1Name || (event.color === settingsData.parentsColors.parent1 && event.title !== settingsData.parent2Name) ) {
                    parent1Days += durationDays;
                } else if (event.title === settingsData.parent2Name || (event.color === settingsData.parentsColors.parent2 && event.title !== settingsData.parent1Name)) {
                    parent2Days += durationDays;
                }
            });

            const totalDays = parent1Days + parent2Days;
            let finalP1 = 0;
            let finalP2 = 0;

            if (totalDays > 0) {
                finalP1 = Math.round((parent1Days / totalDays) * 100);
                finalP2 = 100 - finalP1; 
            }
            
            const p1El = document.getElementById('dashboardParent1Percentage');
            const p2El = document.getElementById('dashboardParent2Percentage');
            if(p1El) {
                p1El.textContent = `${finalP1}%`;
                p1El.style.backgroundColor = settingsData.parentsColors.parent1;
            }
            if(p2El) {
                p2El.textContent = `${finalP2}%`;
                p2El.style.backgroundColor = settingsData.parentsColors.parent2;
            }
            document.getElementById('dashboardParent1Name').textContent = settingsData.parent1Name;
            document.getElementById('dashboardParent2Name').textContent = settingsData.parent2Name;

            window.dashboardCustodyChart.data.labels = [settingsData.parent1Name, settingsData.parent2Name];
            window.dashboardCustodyChart.data.datasets[0].data = [finalP1, finalP2];
            window.dashboardCustodyChart.data.datasets[0].backgroundColor = [settingsData.parentsColors.parent1, settingsData.parentsColors.parent2];
            window.dashboardCustodyChart.update();
            console.log(`Dashboard custody chart updated: ${settingsData.parent1Name} ${finalP1}%, ${settingsData.parent2Name} ${finalP2}%`);
        }


        function refreshTransitionMap() { 
            if (!mapInstance && document.getElementById('map') && typeof L !== 'undefined') {
                 mapInstance = L.map('map').setView([48.856614, 2.3522219], 11); 
                 L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors' }).addTo(mapInstance);
            }
            if (mapInstance) {
                mapInstance.eachLayer((layer) => {
                    if (layer instanceof L.Marker) {
                        mapInstance.removeLayer(layer);
                    }
                });
                if (settingsData.transitionLocations && settingsData.transitionLocations.length > 0) {
                    settingsData.transitionLocations.forEach(location => {
                        if(location.lat && location.lng) { 
                             L.marker([location.lat, location.lng]).addTo(mapInstance).bindPopup(location.name);
                        }
                    });
                    if(settingsData.transitionLocations.length > 0 && settingsData.transitionLocations[0].lat && settingsData.transitionLocations[0].lng) {
                        mapInstance.setView([settingsData.transitionLocations[0].lat, settingsData.transitionLocations[0].lng], 11);
                    }
                } else {
                     mapInstance.setView([48.856614, 2.3522219], 11); 
                }
                 setTimeout(() => { if (mapInstance) mapInstance.invalidateSize() }, 10);
            }
        }
        function setupEventListeners() { 
            const darkModeToggle = document.getElementById('darkModeToggle');
            if (darkModeToggle) darkModeToggle.addEventListener('click', toggleDarkMode);
        }

        function setupCalendarEventListeners() {
            const applyConfigBtn = document.getElementById('applyCustodyConfigButton');
            if (applyConfigBtn) applyConfigBtn.addEventListener('click', applyCustodyConfiguration);

            const addExceptionBtn = document.getElementById('addExceptionButton');
            if (addExceptionBtn) addExceptionBtn.addEventListener('click', addCustodyException);
            
            const exceptionParent1Btn = document.getElementById('exceptionParent1Button');
            const exceptionParent2Btn = document.getElementById('exceptionParent2Button');
            const selectedExceptionParentInput = document.getElementById('selectedExceptionParent');

            if(exceptionParent1Btn && exceptionParent2Btn && selectedExceptionParentInput) {
                exceptionParent1Btn.addEventListener('click', () => {
                    selectedExceptionParentInput.value = settingsData.parent1Name;
                    exceptionParent1Btn.classList.add('parent1-color'); 
                    exceptionParent1Btn.classList.remove('bg-gray-200');
                    exceptionParent2Btn.classList.remove('parent2-color'); 
                    exceptionParent2Btn.classList.add('bg-gray-200');
                    exceptionParent1Btn.textContent = settingsData.parent1Name;
                    exceptionParent2Btn.textContent = settingsData.parent2Name;
                });
                exceptionParent2Btn.addEventListener('click', () => {
                    selectedExceptionParentInput.value = settingsData.parent2Name;
                    exceptionParent2Btn.classList.add('parent2-color');
                    exceptionParent2Btn.classList.remove('bg-gray-200');
                    exceptionParent1Btn.classList.remove('parent1-color');
                    exceptionParent1Btn.classList.add('bg-gray-200');
                    exceptionParent1Btn.textContent = settingsData.parent1Name;
                    exceptionParent2Btn.textContent = settingsData.parent2Name;
                });
            }
             console.log("Calendar configuration and exception event listeners set up.");
        }

        function setupTransitionEventListeners() {
            const saveSettingsBtn = document.getElementById('saveTransitionSettingsButton');
            if(saveSettingsBtn) saveSettingsBtn.addEventListener('click', saveTransitionSettings);

            const addLocationBtn = document.getElementById('addTransitionLocationButton');
            if(addLocationBtn) addLocationBtn.addEventListener('click', () => {
                const newLocName = prompt("Nom du nouveau lieu (Ex: Parc Central):");
                if (newLocName) {
                    const newLoc = {
                        id: `loc-${Date.now()}`,
                        name: newLocName,
                        address: prompt("Adresse (optionnel):") || '',
                        lat: parseFloat(prompt("Latitude (optionnel, ex: 48.858):")) || null,
                        lng: parseFloat(prompt("Longitude (optionnel, ex: 2.350):")) || null,
                    };
                    settingsData.transitionLocations.push(newLoc);
                    saveData('settingsData', settingsData).then(() => {
                        renderTransitionLocations();
                        refreshTransitionMap();
                        populateTransitionSettingsForm(); 
                        alert("Lieu ajouté (fonctionnalité basique).");
                    });
                }
            });
             const addManualTransitionBtn = document.getElementById('addManualTransitionButton');
            if(addManualTransitionBtn) addManualTransitionBtn.addEventListener('click', () => {
                alert("Ajout manuel de transition - à implémenter.");
            });
        }


        function renderDashboardChildrenList() { 
            const dashboardChildrenListEl = document.getElementById('dashboardChildrenList');
            if (!dashboardChildrenListEl) return;
            dashboardChildrenListEl.innerHTML = ''; 

            if (childrenData && childrenData.length > 0) {
                childrenData.slice(0, 2).forEach(child => { 
                    const age = calculateAge(child.dob);
                    const div = document.createElement('div');
                    div.className = 'bg-gray-50 p-3 rounded-lg';
                    div.innerHTML = `
                        <h3 class="font-semibold">${child.name}</h3>
                        <p class="text-sm text-gray-600">${age} ans ${child.dob ? '(' + new Date(child.dob).toLocaleDateString('fr-FR') + ')' : ''}</p>
                        ${child.medicalInfo && child.medicalInfo.length > 0 ? `
                        <div class="mt-2">
                            ${child.medicalInfo.slice(0,2).map(info => `<span class="bg-${info.type === 'allergy' ? 'red' : 'yellow'}-100 text-${info.type === 'allergy' ? 'red' : 'yellow'}-800 text-xs px-2 py-1 rounded-full">${info.text.split('(')[0].trim()}</span>`).join(' ')}
                        </div>` : ''}
                    `;
                    dashboardChildrenListEl.appendChild(div);
                });
                 if (childrenData.length > 2) {
                    const seeMoreButton = document.createElement('button');
                    seeMoreButton.className = 'w-full mt-2 text-blue-500 hover:underline text-sm';
                    seeMoreButton.textContent = 'Voir tous les enfants...';
                    seeMoreButton.onclick = () => switchTab('children');
                    dashboardChildrenListEl.appendChild(seeMoreButton);
                }

            } else {
                dashboardChildrenListEl.innerHTML = '<p class="text-sm text-gray-500">Aucun enfant ajouté pour le moment.</p>';
            }
            const addDashboardChildButton = document.createElement('button');
            addDashboardChildButton.className = 'w-full mt-2 border border-dashed border-gray-300 text-gray-500 rounded-lg p-2 hover:bg-gray-50';
            addDashboardChildButton.innerHTML = '<i class="fas fa-plus mr-1"></i> Ajouter un enfant';
            addDashboardChildButton.onclick = () => {
                switchTab('children');
                prepareAddChildForm(); 
            };
            dashboardChildrenListEl.appendChild(addDashboardChildButton);
        }

        async function loadSavedData() { 
            childrenData = await loadData('childrenData', []);
            scheduleData = await loadData('scheduleData', []); 
            transitionsData = await loadData('transitionsData', []);
            tasksData = await loadData('tasksData', []); 
            settingsData = await loadData('settingsData', settingsData); 
            actionHistory = await loadData('actionHistory', []);

            if (!settingsData.taskCategories || settingsData.taskCategories.length === 0) {
                settingsData.taskCategories = [
                    { id: 'cat1', name: 'Médical', color: '#ef4444' }, 
                    { id: 'cat2', name: 'Achats', color: '#10b981' }, 
                    { id: 'cat3', name: 'École', color: '#f59e0b' },  
                    { id: 'cat4', name: 'Activités', color: '#8b5cf6' } 
                ];
            }
             if (!settingsData.transitionLocations) settingsData.transitionLocations = [];


            isDarkMode = settingsData.theme === 'dark';
            document.body.classList.toggle('dark-mode', isDarkMode);
            const icon = document.querySelector('#darkModeToggle i');
            if (isDarkMode) { icon.classList.remove('fa-moon'); icon.classList.add('fa-sun'); }
            else { icon.classList.remove('fa-sun'); icon.classList.add('fa-moon'); }
            document.getElementById('currentParent').textContent = settingsData.parent1Name; 
            
            const parent1ColorInput = document.getElementById('parent1CalendarColor'); 
            if (parent1ColorInput) parent1ColorInput.value = settingsData.parentsColors.parent1;
            const parent2ColorInput = document.getElementById('parent2CalendarColor'); 
            if (parent2ColorInput) parent2ColorInput.value = settingsData.parentsColors.parent2;
            
            const custodyModelEl = document.getElementById('custodyModel');
            if(custodyModelEl) custodyModelEl.value = settingsData.custodyModel || 'week-alt';
            const cycleStartDateEl = document.getElementById('cycleStartDate');
            if(cycleStartDateEl) cycleStartDateEl.value = settingsData.cycleStartDate || new Date().toISOString().split('T')[0];
            
            const exceptionParent1Btn = document.getElementById('exceptionParent1Button');
            const exceptionParent2Btn = document.getElementById('exceptionParent2Button');
            if(exceptionParent1Btn) exceptionParent1Btn.textContent = settingsData.parent1Name;
            if(exceptionParent2Btn) exceptionParent2Btn.textContent = settingsData.parent2Name;

            console.log('All data loaded and UI updated (theme, parent names, calendar settings).');
            
            updateGlobalParentNameDisplays(); 
            
            if (childrenData && childrenData.length > 0) {
                showChildProfile(childrenData[0].id); 
            } else {
                showChildProfile(null); 
            }

            if (typeof Chart !== 'undefined') { initializeCharts(); }
        }

        function getNextDate(dateStr, days) {
            const date = new Date(dateStr);
            date.setDate(date.getDate() + days);
            return date.toISOString().split('T')[0];
        }
        
        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7)); 
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            var weekNo = Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
            return weekNo;
        }


        async function applyCustodyConfiguration() {
            const model = document.getElementById('custodyModel').value;
            const startDateStr = document.getElementById('cycleStartDate').value;
            const parent1Color = document.getElementById('parent1CalendarColor').value;
            const parent2Color = document.getElementById('parent2CalendarColor').value;
            const currentUser = document.getElementById('currentParent').textContent || 'Utilisateur inconnu';

            if (!startDateStr) {
                alert("Veuillez sélectionner une date de début de cycle.");
                return;
            }

            settingsData.custodyModel = model;
            settingsData.cycleStartDate = startDateStr;
            settingsData.parentsColors.parent1 = parent1Color;
            settingsData.parentsColors.parent2 = parent2Color;
            
            await saveData('settingsData', settingsData);

            scheduleData = scheduleData.filter(event => !event.extendedProps || !event.extendedProps.generated);

            const newGeneratedEvents = [];
            let currentDate = new Date(startDateStr + "T00:00:00"); 
            const endDateLimit = new Date(currentDate);
            endDateLimit.setFullYear(endDateLimit.getFullYear() + 2); 

            let currentParentForCycle = settingsData.parent1Name; 

            if (model === 'week-alt') {
                let initialWeekNumber = getWeekNumber(new Date(currentDate)); 
                currentParentForCycle = (initialWeekNumber % 2 !== 0) ? settingsData.parent1Name : settingsData.parent2Name;

                while (currentDate < endDateLimit) {
                    const weekStart = new Date(currentDate);
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 7);

                    newGeneratedEvents.push({
                        id: `gen-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                        title: currentParentForCycle,
                        start: weekStart.toISOString().split('T')[0],
                        end: weekEnd.toISOString().split('T')[0],
                        color: currentParentForCycle === settingsData.parent1Name ? settingsData.parentsColors.parent1 : settingsData.parentsColors.parent2,
                        allDay: true,
                        extendedProps: { generated: true, isException: false, reason: '' }
                    });
                    currentParentForCycle = (currentParentForCycle === settingsData.parent1Name) ? settingsData.parent2Name : settingsData.parent1Name;
                    currentDate.setDate(currentDate.getDate() + 7);
                }
            } else if (model === '1-1') {
                 currentParentForCycle = settingsData.parent1Name; 
                while (currentDate < endDateLimit) {
                    const weekStart = new Date(currentDate);
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 7);

                    newGeneratedEvents.push({
                        id: `gen-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                        title: currentParentForCycle,
                        start: weekStart.toISOString().split('T')[0],
                        end: weekEnd.toISOString().split('T')[0],
                        color: currentParentForCycle === settingsData.parent1Name ? settingsData.parentsColors.parent1 : settingsData.parentsColors.parent2,
                        allDay: true,
                        extendedProps: { generated: true, isException: false, reason: '' }
                    });
                    currentParentForCycle = (currentParentForCycle === settingsData.parent1Name) ? settingsData.parent2Name : settingsData.parent1Name;
                    currentDate.setDate(currentDate.getDate() + 7);
                }
            }
            
            scheduleData.push(...newGeneratedEvents);
            await saveData('scheduleData', scheduleData);
            await generateTransitionsFromSchedule(); 
            renderDashboard(); 
            
            actionHistory.push({ timestamp: new Date().toISOString(), user: currentUser, action: 'Configuration planning appliquée', details: `Modèle: ${model}, Début: ${startDateStr}` });
            await saveData('actionHistory', actionHistory);
             renderActionHistory();

            alert("Configuration du planning appliquée et sauvegardée !");
        }

        async function addCustodyException() {
            const dateStr = document.getElementById('exceptionDate').value;
            const selectedParentName = document.getElementById('selectedExceptionParent').value;
            const reason = document.getElementById('exceptionReason').value.trim();
            const currentUser = document.getElementById('currentParent').textContent || 'Utilisateur inconnu';

            if (!dateStr) {
                alert("Veuillez sélectionner une date pour l'exception.");
                return;
            }
            if (!selectedParentName) {
                alert("Veuillez sélectionner un parent pour l'exception.");
                return;
            }

            const exceptionColor = selectedParentName === settingsData.parent1Name ? settingsData.parentsColors.parent1 : settingsData.parentsColors.parent2;
            
            const newExceptionEvent = {
                id: `exc-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                title: `${selectedParentName} (Exception${reason ? ': ' + reason : ''})`,
                start: dateStr,
                end: dateStr, 
                allDay: true,
                color: exceptionColor,
                extendedProps: {
                    isException: true,
                    reason: reason,
                    generated: false 
                }
            };

            scheduleData.push(newExceptionEvent);
            await saveData('scheduleData', scheduleData);
            await generateTransitionsFromSchedule(); 
            renderDashboard(); 

            actionHistory.push({ 
                timestamp: new Date().toISOString(), 
                user: currentUser, 
                action: 'Ajout exception calendrier', 
                details: `Date: ${dateStr}, Parent: ${selectedParentName}, Raison: ${reason || 'N/A'}` 
            });
            await saveData('actionHistory', actionHistory);
            renderActionHistory();

            document.getElementById('exceptionDate').value = '';
            document.getElementById('selectedExceptionParent').value = '';
            document.getElementById('exceptionReason').value = '';
            const exceptionParent1Btn = document.getElementById('exceptionParent1Button');
            const exceptionParent2Btn = document.getElementById('exceptionParent2Button');
            exceptionParent1Btn.classList.add('parent1-color');
            exceptionParent1Btn.classList.remove('bg-gray-200');
            exceptionParent2Btn.classList.remove('parent2-color');
            exceptionParent2Btn.classList.add('bg-gray-200');
            exceptionParent1Btn.textContent = settingsData.parent1Name;
            exceptionParent2Btn.textContent = settingsData.parent2Name;

            alert("Exception ajoutée au calendrier !");
        }

        // --- Transitions Management Functions ---
        async function generateTransitionsFromSchedule() {
            console.log("generateTransitionsFromSchedule: Starting.");
            if (!scheduleData || scheduleData.length === 0) {
                transitionsData = [];
                await saveData('transitionsData', transitionsData);
                console.log("generateTransitionsFromSchedule: No schedule data, cleared transitionsData.");
                return;
            }

            const sortedSchedule = [...scheduleData].sort((a, b) => new Date(a.start) - new Date(b.start));
            console.log(`generateTransitionsFromSchedule: Processing ${sortedSchedule.length} schedule events.`);
            
            // Keep manual transitions
            const manualTransitions = transitionsData.filter(t => !t.autoGenerated);
            let newAutoTransitions = [];
            console.log(`generateTransitionsFromSchedule: Kept ${manualTransitions.length} manual transitions.`);

            let lastParent = null;
            for (let i = 0; i < sortedSchedule.length; i++) {
                const currentEvent = sortedSchedule[i];
                let currentEventParentName = null;

                // Determine parent for the current event
                if (currentEvent.title.includes(settingsData.parent1Name)) {
                    currentEventParentName = settingsData.parent1Name;
                } else if (currentEvent.title.includes(settingsData.parent2Name)) {
                    currentEventParentName = settingsData.parent2Name;
                }
                // else, currentEventParentName remains null (e.g. a generic holiday not assigned to a parent)

                if (lastParent && currentEventParentName && currentEventParentName !== lastParent) {
                    // This is a change of custody, a potential transition point.
                    // Check if a manual transition already covers this exact day and parent switch.
                    const existingManualForThisDay = manualTransitions.find(t => 
                        t.date === currentEvent.start && 
                        t.fromParent === lastParent && 
                        t.toParent === currentEventParentName
                    );

                    if (existingManualForThisDay) {
                        console.log(`generateTransitionsFromSchedule: Manual transition already exists for ${currentEvent.start} from ${lastParent} to ${currentEventParentName}. Skipping auto-generation.`);
                    } else {
                        const defaultLocation = settingsData.transitionLocations.find(loc => loc.id === settingsData.defaultTransitionLocationId);
                        const newTransition = {
                            id: `trans-auto-${Date.now()}-${Math.random().toString(36).substr(2,5)}-${i}`, // Added index for more unique ID
                            scheduleEventId: currentEvent.id,
                            date: currentEvent.start, 
                            time: settingsData.defaultTransitionTime || '18:00',
                            fromParent: lastParent,
                            toParent: currentEventParentName,
                            location: defaultLocation ? defaultLocation.name : (settingsData.transitionLocations.length > 0 ? settingsData.transitionLocations[0].name : 'Lieu non défini'),
                            locationId: settingsData.defaultTransitionLocationId || (settingsData.transitionLocations.length > 0 ? settingsData.transitionLocations[0].id : null),
                            confirmed: false,
                            notes: '',
                            autoGenerated: true
                        };
                        newAutoTransitions.push(newTransition);
                        // console.log(`generateTransitionsFromSchedule: Generated auto-transition for ${newTransition.date} from ${newTransition.fromParent} to ${newTransition.toParent}`);
                    }
                }
                if (currentEventParentName) { // Only update lastParent if the current event clearly defines a parent
                    lastParent = currentEventParentName;
                }
            }
            
            transitionsData = [...manualTransitions, ...newAutoTransitions];
            await saveData('transitionsData', transitionsData);
            console.log(`generateTransitionsFromSchedule: Completed. Generated ${newAutoTransitions.length} new auto-transitions. Total transitions now: ${transitionsData.length}.`);
        }

        function renderTransitions() {
            const upcomingListEl = document.getElementById('upcomingTransitionsList');
            const pastListEl = document.getElementById('pastTransitionsList');
            if (!upcomingListEl || !pastListEl) return;

            upcomingListEl.innerHTML = '';
            pastListEl.innerHTML = '';

            const now = new Date();
            const sortedTransitions = [...transitionsData].sort((a,b) => new Date(a.date + 'T' + a.time) - new Date(b.date + 'T' + b.time));

            let upcomingCount = 0;
            let pastCount = 0;

            sortedTransitions.forEach(trans => {
                const transDateTime = new Date(trans.date + 'T' + trans.time);
                const locationName = trans.locationId ? (settingsData.transitionLocations.find(l => l.id === trans.locationId)?.name || trans.location || 'Lieu non spécifié') : (trans.location || 'Lieu non spécifié');

                const li = document.createElement('li');
                li.className = `p-3 rounded-lg border-l-4 ${transDateTime >= now ? 'bg-orange-50 border-orange-500' : 'bg-gray-50 border-gray-300'}`;
                
                let confirmButtonHTML = '';
                if (transDateTime >= now) { 
                    if (trans.confirmed) {
                        confirmButtonHTML = `<span class="text-green-600 font-semibold"><i class="fas fa-check-circle mr-1"></i> Confirmée</span>`;
                    } else {
                        confirmButtonHTML = `<button onclick="confirmTransition('${trans.id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-sm"><i class="fas fa-check mr-1"></i> Confirmer</button>`;
                    }
                } else { 
                     confirmButtonHTML = trans.confirmed ? `<span class="text-green-600 text-xs"><i class="fas fa-check-double mr-1"></i> Effectuée</span>` : `<span class="text-gray-500 text-xs">Non confirmée</span>`;
                }


                li.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-semibold">${new Date(trans.date).toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}, ${trans.time}</h3>
                            <p class="text-sm">${trans.fromParent} → ${trans.toParent}</p>
                            <p class="text-sm text-gray-600">Lieu: ${locationName}</p>
                            ${trans.notes ? `<p class="text-xs text-gray-500 mt-1">Note: ${trans.notes}</p>` : ''}
                        </div>
                        <div class="text-right space-y-1">
                            ${confirmButtonHTML}
                            ${transDateTime >= now ? `<button onclick="editTransition('${trans.id}')" class="bg-gray-500 hover:bg-gray-600 text-white px-2 py-1 rounded text-sm ml-1"><i class="fas fa-pen"></i></button>` : ''}
                        </div>
                    </div>
                `;

                if (transDateTime >= now) {
                    upcomingListEl.appendChild(li);
                    upcomingCount++;
                } else {
                    pastListEl.appendChild(li);
                    pastCount++;
                }
            });

            if(upcomingCount === 0) upcomingListEl.innerHTML = '<li>Aucune transition à venir.</li>';
            if(pastCount === 0) pastListEl.innerHTML = '<li>Aucune transition passée.</li>';
        }
        
        function renderDashboardNextTransition() {
            const dashboardEl = document.getElementById('nextTransitionDashboard');
            if (!dashboardEl) return;

            const now = new Date();
            const upcomingTransitions = transitionsData
                .filter(t => new Date(t.date + 'T' + t.time) >= now)
                .sort((a,b) => new Date(a.date + 'T' + a.time) - new Date(b.date + 'T' + b.time));

            if (upcomingTransitions.length > 0) {
                const nextTrans = upcomingTransitions[0];
                const locationName = nextTrans.locationId ? (settingsData.transitionLocations.find(l => l.id === nextTrans.locationId)?.name || nextTrans.location || 'Lieu non spécifié') : (nextTrans.location || 'Lieu non spécifié');
                const transDateTime = new Date(nextTrans.date + 'T' + nextTrans.time);
                const daysUntil = Math.ceil((transDateTime - now) / (1000 * 60 * 60 * 24));
                let daysText = daysUntil === 1 ? 'Demain' : `Dans ${daysUntil} jours`;
                if (daysUntil === 0) daysText = "Aujourd'hui";
                if (daysUntil < 0) daysText = ""; 

                dashboardEl.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-bold">${transDateTime.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}, ${nextTrans.time}</p>
                            <p>${nextTrans.fromParent} → ${nextTrans.toParent}</p>
                            <p class="text-sm text-gray-600">Lieu: ${locationName}</p>
                        </div>
                        <div class="text-right">
                            ${daysText ? `<span class="bg-orange-500 text-white text-xs px-2 py-1 rounded-full">${daysText}</span>` : ''}
                             ${!nextTrans.confirmed ? `<button onclick="confirmTransition('${nextTrans.id}', true)" class="mt-2 bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg text-sm"><i class="fas fa-check mr-1"></i> Confirmer</button>` : `<span class="mt-2 inline-block text-green-600"><i class="fas fa-check-circle"></i> Confirmée</span>`}
                        </div>
                    </div>
                `;
            } else {
                dashboardEl.innerHTML = '<p>Aucune transition à venir programmée.</p>';
            }
        }


        async function confirmTransition(transitionId, fromDashboard = false) {
            const transIndex = transitionsData.findIndex(t => t.id === transitionId);
            if (transIndex > -1) {
                transitionsData[transIndex].confirmed = true;
                await saveData('transitionsData', transitionsData);
                renderTransitions(); 
                if(fromDashboard) renderDashboardNextTransition(); 
                actionHistory.push({ timestamp: new Date().toISOString(), user: document.getElementById('currentParent').textContent, action: 'Transition confirmée', details: `ID: ${transitionId}` });
                await saveData('actionHistory', actionHistory);
                renderActionHistory();
            }
        }

        function editTransition(transitionId) {
            alert(`Modification de la transition ID: ${transitionId} - À implémenter.`);
        }


        function renderTransitionLocations() {
            const listEl = document.getElementById('transitionLocationsList');
            const defaultLocationDropdown = document.getElementById('defaultTransitionLocationId');
            if (!listEl || !defaultLocationDropdown) return;

            listEl.innerHTML = '';
            defaultLocationDropdown.innerHTML = '<option value="">-- Sélectionner un lieu --</option>'; 

            if (settingsData.transitionLocations && settingsData.transitionLocations.length > 0) {
                settingsData.transitionLocations.forEach(loc => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center p-2 bg-gray-50 rounded-lg';
                    li.innerHTML = `
                        <div class="flex items-center">
                            <span class="transition-marker mr-2" style="background-color: ${ L.Icon.Default.prototype.options.iconUrl ? '#f6ad55' : '#ccc'}"></span>
                            <span>${loc.name} ${loc.address ? '('+loc.address+')': ''}</span>
                        </div>
                        <div>
                            <button onclick="editTransitionLocation('${loc.id}')" class="text-blue-500 hover:text-blue-700 text-xs"><i class="fas fa-pen"></i></button>
                            <button onclick="deleteTransitionLocation('${loc.id}')" class="text-red-500 hover:text-red-700 ml-2 text-xs"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    listEl.appendChild(li);

                    const option = document.createElement('option');
                    option.value = loc.id;
                    option.textContent = loc.name;
                    defaultLocationDropdown.appendChild(option);
                });
            } else {
                listEl.innerHTML = '<li>Aucun lieu enregistré.</li>';
            }
             if(settingsData.defaultTransitionLocationId) {
                defaultLocationDropdown.value = settingsData.defaultTransitionLocationId;
            }
        }
        
        function editTransitionLocation(locId){ alert(`Modification lieu ID: ${locId} - à implémenter.`);}
        function deleteTransitionLocation(locId){ alert(`Suppression lieu ID: ${locId} - à implémenter.`);}


        function populateTransitionSettingsForm() {
            document.getElementById('defaultTransitionTime').value = settingsData.defaultTransitionTime || '18:00';
            document.getElementById('defaultTransitionLocationId').value = settingsData.defaultTransitionLocationId || '';
            document.getElementById('notifyDayBefore').checked = settingsData.notificationPreferences.notifyDayBefore === true;
            document.getElementById('notifyHourBefore').checked = settingsData.notificationPreferences.notifyHourBefore === true;
            document.getElementById('requestConfirmTransition').checked = settingsData.notificationPreferences.requestConfirmTransition === true;
        }

        async function saveTransitionSettings() {
            settingsData.defaultTransitionTime = document.getElementById('defaultTransitionTime').value;
            settingsData.defaultTransitionLocationId = document.getElementById('defaultTransitionLocationId').value;
            settingsData.notificationPreferences.notifyDayBefore = document.getElementById('notifyDayBefore').checked;
            settingsData.notificationPreferences.notifyHourBefore = document.getElementById('notifyHourBefore').checked;
            settingsData.notificationPreferences.requestConfirmTransition = document.getElementById('requestConfirmTransition').checked;

            await saveData('settingsData', settingsData);
            actionHistory.push({ timestamp: new Date().toISOString(), user: document.getElementById('currentParent').textContent, action: 'Paramètres transitions sauvegardés' });
            await saveData('actionHistory', actionHistory);
            renderActionHistory();
            alert("Paramètres des transitions sauvegardés !");
        }

        // --- Tasks Management Functions ---
        function setupTaskEventListeners() {
            document.getElementById('showNewTaskFormButton').addEventListener('click', showNewTaskForm);
            document.getElementById('taskForm').addEventListener('submit', saveTaskForm);
            document.getElementById('cancelTaskFormButton').addEventListener('click', hideTaskForm);
            document.getElementById('addTaskCategoryButton').addEventListener('click', addTaskCategory);
            
            const statusFilters = document.getElementById('taskStatusFilters');
            if(statusFilters) {
                statusFilters.addEventListener('click', (e) => {
                    if (e.target.matches('.task-filter-button')) {
                        currentTaskFilter.status = e.target.dataset.statusFilter;
                        renderTasks(currentTaskFilter);
                        statusFilters.querySelectorAll('.task-filter-button').forEach(btn => {
                            btn.classList.remove('bg-blue-100', 'text-blue-800');
                            btn.classList.add('bg-gray-100', 'text-gray-800');
                        });
                        e.target.classList.add('bg-blue-100', 'text-blue-800');
                        e.target.classList.remove('bg-gray-100', 'text-gray-800');
                    }
                });
            }
             const categoryFiltersContainer = document.getElementById('taskCategoryFilters');
            if (categoryFiltersContainer) {
                categoryFiltersContainer.addEventListener('click', (e) => {
                    const button = e.target.closest('.task-category-filter-button');
                    if (button) {
                        const catId = button.dataset.categoryIdFilter;
                        currentTaskFilter.categoryId = currentTaskFilter.categoryId === catId ? 'all' : catId;
                        renderTasks(currentTaskFilter);
                        categoryFiltersContainer.querySelectorAll('.task-category-filter-button').forEach(btn => {
                            btn.classList.remove('bg-blue-100', 'text-blue-800');
                            btn.classList.add('bg-gray-100', 'text-gray-800');
                        });
                        if (currentTaskFilter.categoryId === catId) {
                            button.classList.add('bg-blue-100', 'text-blue-800');
                            button.classList.remove('bg-gray-100', 'text-gray-800');
                        }
                    }
                });
            }
        }

        function renderTaskCategories() {
            const categoriesListEl = document.getElementById('taskCategoriesList');
            const categoryFiltersContainer = document.getElementById('taskCategoryFilters');
            const taskCategoryDropdown = document.getElementById('taskCategoryInput');

            if (categoriesListEl) categoriesListEl.innerHTML = '';
            if (categoryFiltersContainer) categoryFiltersContainer.innerHTML = '';
            if (taskCategoryDropdown) taskCategoryDropdown.innerHTML = '<option value="">-- Sélectionner --</option>';


            if (settingsData.taskCategories && settingsData.taskCategories.length > 0) {
                settingsData.taskCategories.forEach(cat => {
                    if (categoriesListEl) {
                        const li = document.createElement('li');
                        li.className = 'flex justify-between items-center p-2 rounded-lg';
                        li.style.borderLeft = `4px solid ${cat.color}`;
                        li.innerHTML = `
                            <div class="flex items-center">
                                <span class="w-3 h-3 rounded-full mr-2" style="background-color: ${cat.color};"></span>
                                <span>${cat.name}</span>
                            </div>
                            <div>
                                <button onclick="editTaskCategory('${cat.id}')" class="text-blue-500 hover:text-blue-700 text-xs"><i class="fas fa-pen"></i></button>
                                <button onclick="deleteTaskCategory('${cat.id}')" class="text-red-500 hover:text-red-700 text-xs ml-1"><i class="fas fa-trash"></i></button>
                            </div>
                        `;
                        categoriesListEl.appendChild(li);
                    }

                    if (categoryFiltersContainer) {
                        const button = document.createElement('button');
                        button.className = `task-category-filter-button px-3 py-1 rounded-lg text-sm mr-2 mb-2 ${currentTaskFilter.categoryId === cat.id ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'}`;
                        button.dataset.categoryIdFilter = cat.id;
                        button.innerHTML = `<span class="w-2 h-2 rounded-full inline-block mr-1" style="background-color: ${cat.color};"></span>${cat.name}`;
                        categoryFiltersContainer.appendChild(button);
                    }
                    if (taskCategoryDropdown) {
                        const option = document.createElement('option');
                        option.value = cat.id;
                        option.textContent = cat.name;
                        taskCategoryDropdown.appendChild(option);
                    }
                });
            } else {
                if (categoriesListEl) categoriesListEl.innerHTML = '<li class="text-sm text-gray-500">Aucune catégorie.</li>';
                if (categoryFiltersContainer) categoryFiltersContainer.innerHTML = '<span class="text-sm text-gray-500">Aucune catégorie à filtrer.</span>';
            }
        }

        async function addTaskCategory() {
            const name = prompt("Nom de la nouvelle catégorie:");
            if (!name) return;
            const color = prompt("Couleur de la catégorie (code hexadécimal, ex: #ff0000):", "#cccccc");
            if (!color) return; 

            const newCategory = {
                id: `cat-${Date.now()}`,
                name: name.trim(),
                color: color.trim()
            };
            settingsData.taskCategories.push(newCategory);
            await saveData('settingsData', settingsData);
            renderTaskCategories();
            actionHistory.push({ timestamp: new Date().toISOString(), user: document.getElementById('currentParent').textContent, action: 'Ajout catégorie de tâche', details: newCategory.name });
            await saveData('actionHistory', actionHistory);
            renderActionHistory();
        }
        
        function editTaskCategory(categoryId) { alert(`Modification catégorie ID: ${categoryId} - à implémenter.`); }
        function deleteTaskCategory(categoryId) { alert(`Suppression catégorie ID: ${categoryId} - à implémenter.`); }


        function showNewTaskForm() {
            editingTaskId = null; 
            document.getElementById('taskForm').reset(); 
            document.getElementById('taskFormTitle').textContent = 'Nouvelle tâche';
            document.getElementById('saveTaskFormButton').textContent = 'Enregistrer la tâche';
            
            const parentDropdown = document.getElementById('taskAssignedParentInput');
            parentDropdown.innerHTML = '<option value="Anyone">N\'importe qui</option>'; 
            const p1opt = document.createElement('option');
            p1opt.value = settingsData.parent1Name;
            p1opt.textContent = settingsData.parent1Name;
            parentDropdown.appendChild(p1opt);
            const p2opt = document.createElement('option');
            p2opt.value = settingsData.parent2Name;
            p2opt.textContent = settingsData.parent2Name;
            parentDropdown.appendChild(p2opt);
            
            renderTaskCategories(); // Ensures category dropdown is populated

            document.getElementById('taskFormContainer').classList.remove('hidden');
        }

        function hideTaskForm() {
            document.getElementById('taskFormContainer').classList.add('hidden');
            editingTaskId = null;
        }

        async function saveTaskForm(event) {
            event.preventDefault();
            const currentUser = document.getElementById('currentParent').textContent;
            const description = document.getElementById('taskDescriptionInput').value.trim();
            const details = document.getElementById('taskDetailsInput').value.trim();
            const assignedParentName = document.getElementById('taskAssignedParentInput').value;
            const categoryId = document.getElementById('taskCategoryInput').value;
            const dueDate = document.getElementById('taskDueDateInput').value;

            if (!description || !categoryId) {
                alert("La description et la catégorie sont requises.");
                return;
            }
            const category = settingsData.taskCategories.find(c => c.id === categoryId);
            if (!category) {
                alert("Catégorie invalide sélectionnée.");
                return;
            }

            if (editingTaskId) { 
                const taskIndex = tasksData.findIndex(t => t.id === editingTaskId);
                if (taskIndex > -1) {
                    tasksData[taskIndex] = {
                        ...tasksData[taskIndex],
                        description, details, assignedParentName, 
                        category: category.name, categoryId, dueDate
                    };
                    actionHistory.push({ timestamp: new Date().toISOString(), user: currentUser, action: 'Modification tâche', details: description });
                }
            } else { 
                const newTask = {
                    id: `task-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`,
                    description, details, assignedParentName, 
                    category: category.name, categoryId, dueDate,
                    status: 'pending',
                    createdAt: new Date().toISOString().split('T')[0]
                };
                tasksData.push(newTask);
                actionHistory.push({ timestamp: new Date().toISOString(), user: currentUser, action: 'Ajout tâche', details: description });
            }

            await saveData('tasksData', tasksData);
            await saveData('actionHistory', actionHistory);
            renderTasks(currentTaskFilter);
            renderDashboard(); 
            hideTaskForm();
            renderActionHistory();
        }

        function renderTasks(filterParams = { status: 'all', categoryId: 'all' }) {
            const tasksListEl = document.getElementById('tasksList');
            if (!tasksListEl) return;
            tasksListEl.innerHTML = '';

            let filteredTasks = [...tasksData];

            if (filterParams.status !== 'all') {
                filteredTasks = filteredTasks.filter(task => task.status === filterParams.status);
            }
            if (filterParams.categoryId !== 'all') {
                filteredTasks = filteredTasks.filter(task => task.categoryId === filterParams.categoryId);
            }
            
            filteredTasks.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt)); 

            if (filteredTasks.length === 0) {
                tasksListEl.innerHTML = '<li class="text-gray-500">Aucune tâche ne correspond à ces filtres.</li>';
                updateTaskStats(); 
                renderDashboardTasks(); 
                return;
            }

            filteredTasks.forEach(task => {
                const category = settingsData.taskCategories.find(c => c.id === task.categoryId) || { name: 'Inconnue', color: '#cccccc' };
                const li = document.createElement('li');
                li.className = `task-item bg-gray-50 p-3 rounded-lg border-l-4 ${task.status === 'completed' ? 'task-completed' : ''}`;
                li.style.borderLeftColor = category.color;

                li.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-semibold">${task.description}</h3>
                            <p class="text-sm text-gray-600">${task.details || ''}</p>
                            <div class="mt-1">
                                <span class="text-xs px-2 py-0.5 rounded-full" style="background-color: ${category.color}33; color: ${category.color}; border: 1px solid ${category.color};">${category.name}</span>
                                <span class="text-xs text-gray-500 ml-2">Créée le: ${new Date(task.createdAt).toLocaleDateString('fr-FR')}</span>
                                ${task.dueDate ? `<span class="text-xs text-gray-500 ml-2">Échéance: ${new Date(task.dueDate + "T00:00:00").toLocaleDateString('fr-FR')}</span>` : ''}
                            </div>
                        </div>
                        <div class="text-right space-y-1">
                             <span class="text-xs px-2 py-1 rounded-full ${task.assignedParentName === settingsData.parent1Name ? 'bg-blue-100 text-blue-800' : (task.assignedParentName === settingsData.parent2Name ? 'bg-pink-100 text-pink-800' : 'bg-gray-200 text-gray-700')}">${task.assignedParentName}</span>
                            <div class="mt-2">
                                <button onclick="toggleTaskStatus('${task.id}')" class="${task.status === 'pending' ? 'bg-green-500 hover:bg-green-600' : 'bg-yellow-500 hover:bg-yellow-600'} text-white px-2 py-1 rounded text-sm">
                                    <i class="fas ${task.status === 'pending' ? 'fa-check' : 'fa-undo'} mr-1"></i> ${task.status === 'pending' ? 'Terminer' : 'Annuler'}
                                </button>
                                <button onclick="editTask('${task.id}')" class="bg-gray-500 hover:bg-gray-600 text-white px-2 py-1 rounded text-sm ml-1">
                                    <i class="fas fa-pen"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                tasksListEl.appendChild(li);
            });
            updateTaskStats();
            renderDashboardTasks();
        }
        
        async function toggleTaskStatus(taskId) {
            const taskIndex = tasksData.findIndex(t => t.id === taskId);
            if (taskIndex > -1) {
                tasksData[taskIndex].status = tasksData[taskIndex].status === 'pending' ? 'completed' : 'pending';
                await saveData('tasksData', tasksData);
                renderTasks(currentTaskFilter); 
                actionHistory.push({ timestamp: new Date().toISOString(), user: document.getElementById('currentParent').textContent, action: `Statut tâche modifié: ${tasksData[taskIndex].status}`, details: tasksData[taskIndex].description });
                await saveData('actionHistory', actionHistory);
                renderActionHistory();
            }
        }

        function editTask(taskId) {
            const task = tasksData.find(t => t.id === taskId);
            if (task) {
                editingTaskId = taskId;
                document.getElementById('taskFormTitle').textContent = 'Modifier la tâche';
                document.getElementById('saveTaskFormButton').textContent = 'Sauvegarder les modifications';
                
                document.getElementById('taskIdInput').value = task.id;
                document.getElementById('taskDescriptionInput').value = task.description;
                document.getElementById('taskDetailsInput').value = task.details || '';
                document.getElementById('taskAssignedParentInput').value = task.assignedParentName;
                document.getElementById('taskCategoryInput').value = task.categoryId;
                document.getElementById('taskDueDateInput').value = task.dueDate || '';
                
                document.getElementById('taskFormContainer').classList.remove('hidden');
            }
        }

        function updateTaskStats() {
            const pendingTasks = tasksData.filter(t => t.status === 'pending').length;
            const completedTasks = tasksData.filter(t => t.status === 'completed').length;
            const totalTasks = tasksData.length;

            document.getElementById('pendingTasksCount').textContent = pendingTasks;
            document.getElementById('completedTasksCount').textContent = completedTasks;

            const pendingBar = document.getElementById('pendingTasksBar');
            if(pendingBar) pendingBar.style.width = totalTasks > 0 ? `${(pendingTasks / totalTasks) * 100}%` : '0%';
            const completedBar = document.getElementById('completedTasksBar');
            if(completedBar) completedBar.style.width = totalTasks > 0 ? `${(completedTasks / totalTasks) * 100}%` : '0%';

            const tasksParent1Count = tasksData.filter(t => t.assignedParentName === settingsData.parent1Name).length;
            const tasksParent2Count = tasksData.filter(t => t.assignedParentName === settingsData.parent2Name).length;
            const tasksAnyoneCount = tasksData.filter(t => t.assignedParentName === 'Anyone').length;

            document.getElementById('tasksParent1Count').textContent = tasksParent1Count;
            document.getElementById('tasksParent2Count').textContent = tasksParent2Count;

            if (window.taskDistributionChartInstance) {
                window.taskDistributionChartInstance.data.datasets[0].data = [tasksParent1Count, tasksParent2Count, tasksAnyoneCount];
                window.taskDistributionChartInstance.data.labels = [settingsData.parent1Name, settingsData.parent2Name, 'N\'importe qui']; 
                window.taskDistributionChartInstance.update();
            }
        }
        
        function renderDashboardTasks() {
            const listEl = document.getElementById('dashboardTasksList');
            if (!listEl) return;
            listEl.innerHTML = '';
            const upcomingTasks = tasksData
                .filter(t => t.status === 'pending')
                .sort((a,b) => {
                    const dateA = a.dueDate ? new Date(a.dueDate + "T00:00:00") : new Date('9999-12-31'); 
                    const dateB = b.dueDate ? new Date(b.dueDate + "T00:00:00") : new Date('9999-12-31');
                    return dateA - dateB;
                })
                .slice(0,2); 

            if (upcomingTasks.length === 0) {
                listEl.innerHTML = '<li class="text-sm text-gray-500">Aucune tâche en attente.</li>';
                return;
            }
            upcomingTasks.forEach(task => {
                const category = settingsData.taskCategories.find(c => c.id === task.categoryId) || { name: 'Inconnue', color: '#cccccc' };
                const li = document.createElement('li');
                li.className = 'task-item bg-gray-50 p-3 rounded-lg border-l-4';
                li.style.borderLeftColor = category.color;
                li.innerHTML = `
                    <div class="flex justify-between">
                        <div>
                            <h3 class="font-semibold">${task.description}</h3>
                            <p class="text-sm text-gray-600">${task.details.substring(0,50)}${task.details.length > 50 ? '...' : ''}</p>
                        </div>
                        <div class="text-sm">
                            <span class="px-2 py-0.5 rounded-full text-xs" style="background-color: ${category.color}33; color: ${category.color}; border: 1px solid ${category.color};">${category.name}</span>
                        </div>
                    </div>
                `;
                listEl.appendChild(li);
            });
        }
        

        // --- Settings Tab Functions ---
        function setupSettingsEventListeners() {
            document.getElementById('saveAccountSettingsButton').addEventListener('click', saveAccountSettings);
            document.getElementById('themeLightButton').addEventListener('click', () => setDisplayTheme('light'));
            document.getElementById('themeDarkButton').addEventListener('click', () => setDisplayTheme('dark'));
            document.getElementById('saveDisplayPreferencesButton').addEventListener('click', saveDisplayPreferences);
            document.getElementById('exportDataButton').addEventListener('click', exportData);
            document.getElementById('importDataInput').addEventListener('change', importData);
            document.getElementById('clearActionHistoryButton').addEventListener('click', clearActionHistory);
        }

        function populateAccountSettingsForm() {
            document.getElementById('parent1NameInput').value = settingsData.parent1Name || '';
            document.getElementById('parent2NameInput').value = settingsData.parent2Name || '';
        }
        
        async function saveAccountSettings() {
            const parent1Name = document.getElementById('parent1NameInput').value.trim();
            const parent2Name = document.getElementById('parent2NameInput').value.trim();
            const oldP1Name = settingsData.parent1Name; // Store old names before updating
            const oldP2Name = settingsData.parent2Name;

            let changed = false;
            if (parent1Name && parent1Name !== settingsData.parent1Name) {
                settingsData.parent1Name = parent1Name;
                changed = true;
            }
            if (parent2Name && parent2Name !== settingsData.parent2Name) {
                settingsData.parent2Name = parent2Name;
                changed = true;
            }
            
            if (changed) {
                await saveData('settingsData', settingsData);
                 // Update currentParent global variable if the current user's name changed
                const currentParentDisplay = document.getElementById('currentParent').textContent;
                if (currentParentDisplay === oldP1Name && oldP1Name !== settingsData.parent1Name) {
                    currentParent = settingsData.parent1Name;
                } else if (currentParentDisplay === oldP2Name && oldP2Name !== settingsData.parent2Name) {
                    currentParent = settingsData.parent2Name;
                }
                document.getElementById('currentParent').textContent = currentParent; // Ensure header is updated

                updateGlobalParentNameDisplays(); 
                
                actionHistory.push({ timestamp: new Date().toISOString(), user: currentParent, action: 'Noms des parents modifiés' });
                await saveData('actionHistory', actionHistory);
                renderActionHistory(); 
                alert("Noms des parents sauvegardés !");
            } else {
                alert("Aucun changement détecté dans les noms des parents.");
            }
        }

        function setDisplayTheme(theme) { 
            settingsData.theme = theme;
            isDarkMode = theme === 'dark';
            document.body.classList.toggle('dark-mode', isDarkMode);
            const icon = document.querySelector('#darkModeToggle i');
            icon.classList.toggle('fa-moon', !isDarkMode);
            icon.classList.toggle('fa-sun', isDarkMode);
            
            // Update theme button active state immediately
            if (settingsData.theme === 'dark') {
                document.getElementById('themeDarkButton').classList.add('ring-2', 'ring-offset-2', 'ring-indigo-500');
                document.getElementById('themeLightButton').classList.remove('ring-2', 'ring-offset-2', 'ring-indigo-500');
            } else {
                document.getElementById('themeLightButton').classList.add('ring-2', 'ring-offset-2', 'ring-indigo-500');
                document.getElementById('themeDarkButton').classList.remove('ring-2', 'ring-offset-2', 'ring-indigo-500');
            }
            // Save is handled by saveDisplayPreferences or if called directly, should be saved there.
        }

        async function saveDisplayPreferences() {
            settingsData.defaultCalendarView = document.getElementById('defaultCalendarViewSelect').value;
            // Theme is already set by setDisplayTheme and updated in settingsData by it
            await saveData('settingsData', settingsData);
            if (fullCalendarInstance) { 
                fullCalendarInstance.changeView(settingsData.defaultCalendarView);
            }
            actionHistory.push({ timestamp: new Date().toISOString(), user: currentParent, action: 'Préférences d\'affichage sauvegardées' });
            await saveData('actionHistory', actionHistory);
            renderActionHistory();
            alert("Préférences d'affichage sauvegardées !");
        }
        
        function populateDisplayPreferencesForm() {
            document.getElementById('defaultCalendarViewSelect').value = settingsData.defaultCalendarView || 'dayGridMonth';
            if (settingsData.theme === 'dark') {
                document.getElementById('themeDarkButton').classList.add('ring-2', 'ring-offset-2', 'ring-indigo-500');
                document.getElementById('themeLightButton').classList.remove('ring-2', 'ring-offset-2', 'ring-indigo-500');
            } else {
                document.getElementById('themeLightButton').classList.add('ring-2', 'ring-offset-2', 'ring-indigo-500');
                document.getElementById('themeDarkButton').classList.remove('ring-2', 'ring-offset-2', 'ring-indigo-500');
            }
        }

        function renderActionHistory() {
            const listEl = document.getElementById('actionHistoryList');
            if (!listEl) return;
            listEl.innerHTML = '';
            if (actionHistory.length === 0) {
                listEl.innerHTML = '<li class="text-gray-500">Aucune action enregistrée.</li>';
                return;
            }
            actionHistory.slice().reverse().forEach(entry => { 
                const li = document.createElement('li');
                li.className = 'bg-gray-50 p-3 rounded-lg text-sm';
                li.innerHTML = `
                    <div class="flex justify-between">
                        <span class="font-semibold">${new Date(entry.timestamp).toLocaleString('fr-FR')}</span>
                        <span class="text-xs ${entry.user === settingsData.parent1Name ? 'text-blue-600' : (entry.user === settingsData.parent2Name ? 'text-pink-600' : 'text-gray-600')}">${entry.user}</span>
                    </div>
                    <p class="text-gray-700">${entry.action}: <span class="text-gray-500">${entry.details || ''}</span></p>
                `;
                listEl.appendChild(li);
            });
        }

        async function clearActionHistory() {
            if (confirm("Êtes-vous sûr de vouloir effacer tout l'historique des modifications ? Cette action est irréversible.")) {
                actionHistory = [];
                await saveData('actionHistory', actionHistory);
                renderActionHistory();
                alert("Historique des modifications effacé.");
            }
        }


        // --- Statistics Tab Functions ---
        function calculateDateRange(preset, customStart, customEnd) {
            const today = new Date();
            today.setHours(0,0,0,0); 
            let startDate, endDate = new Date(today); 

            switch (preset) {
                case 'lastMonth':
                    startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    endDate = new Date(today.getFullYear(), today.getMonth(), 0); 
                    break;
                case 'last3Months':
                    startDate = new Date(today.getFullYear(), today.getMonth() - 3, 1);
                     endDate = new Date(today.getFullYear(), today.getMonth(), 0); 
                    break;
                case 'last6Months':
                    startDate = new Date(today.getFullYear(), today.getMonth() - 6, 1);
                    endDate = new Date(today.getFullYear(), today.getMonth(), 0);
                    break;
                case 'currentYear':
                    startDate = new Date(today.getFullYear(), 0, 1);
                    endDate = today; 
                    break;
                case 'allTime':
                    if (scheduleData.length > 0) {
                        startDate = new Date(Math.min(...scheduleData.map(e => new Date(e.start))));
                    } else {
                         startDate = new Date(today.getFullYear(), 0, 1); 
                    }
                    if (isNaN(startDate.getTime())) startDate = new Date(today.getFullYear(), 0, 1); 
                    endDate = today;
                    break;
                case 'custom':
                    startDate = customStart ? new Date(customStart + "T00:00:00") : new Date(today.getFullYear(), 0, 1);
                    endDate = customEnd ? new Date(customEnd + "T00:00:00") : today;
                    break;
                default: 
                    startDate = new Date(today.getFullYear(), today.getMonth() - 6, 1);
                    endDate = new Date(today.getFullYear(), today.getMonth(), 0);
            }
            return { 
                start: startDate.toISOString().split('T')[0], 
                end: endDate.toISOString().split('T')[0] 
            };
        }

        function setupStatsEventListeners() {
            const presetEl = document.getElementById('statsPeriodPreset');
            const startDateEl = document.getElementById('statsStartDate');
            const endDateEl = document.getElementById('statsEndDate');
            const customDateRangeEl = document.getElementById('statsCustomDateRange');
            const childrenContainer = document.getElementById('statsChildrenFilterContainer');
            const dataTypesContainer = document.getElementById('statsDataTypesFilterContainer');
            const applyBtn = document.getElementById('applyStatsFiltersButton');

            if (presetEl) {
                presetEl.addEventListener('change', (e) => {
                    statsFilters.periodPreset = e.target.value;
                    customDateRangeEl.classList.toggle('hidden', e.target.value !== 'custom');
                    if (e.target.value !== 'custom') renderStatistics();
                });
            }
            if (startDateEl) startDateEl.addEventListener('change', (e) => statsFilters.startDate = e.target.value);
            if (endDateEl) endDateEl.addEventListener('change', (e) => statsFilters.endDate = e.target.value);
            
            if (childrenContainer) {
                childrenContainer.addEventListener('change', (e) => {
                    if (e.target.type === 'checkbox') {
                        const selectedId = e.target.value;
                        if (selectedId === 'all') {
                            statsFilters.selectedChildrenIds = ['all'];
                            childrenContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                                if (cb.value !== 'all') cb.checked = false;
                            });
                        } else {
                            childrenContainer.querySelector('input[value="all"]').checked = false;
                            statsFilters.selectedChildrenIds = Array.from(childrenContainer.querySelectorAll('input[type="checkbox"]:checked'))
                                .map(cb => cb.value)
                                .filter(id => id !== 'all');
                            if (statsFilters.selectedChildrenIds.length === 0) { 
                                childrenContainer.querySelector('input[value="all"]').checked = true;
                                statsFilters.selectedChildrenIds = ['all'];
                            }
                        }
                    }
                });
            }

            if (dataTypesContainer) {
                dataTypesContainer.addEventListener('change', (e) => {
                    if (e.target.type === 'checkbox') {
                        statsFilters.dataTypes = Array.from(dataTypesContainer.querySelectorAll('input[type="checkbox"]:checked'))
                            .map(cb => cb.value);
                    }
                });
            }
            
            if (applyBtn) applyBtn.addEventListener('click', renderStatistics);
            document.getElementById('exportStatsButton').addEventListener('click', () => alert("Exportation des statistiques - à implémenter."));
        }

        function populateStatsFilters() {
            const presetEl = document.getElementById('statsPeriodPreset');
            const startDateEl = document.getElementById('statsStartDate');
            const endDateEl = document.getElementById('statsEndDate');
            const childrenContainer = document.getElementById('statsChildrenFilterContainer');
            const dataTypesContainer = document.getElementById('statsDataTypesFilterContainer');

            if(presetEl) presetEl.value = statsFilters.periodPreset;
            if(startDateEl) startDateEl.value = statsFilters.startDate;
            if(endDateEl) endDateEl.value = statsFilters.endDate;
            document.getElementById('statsCustomDateRange').classList.toggle('hidden', statsFilters.periodPreset !== 'custom');


            if (childrenContainer) {
                childrenContainer.innerHTML = `
                    <div class="flex items-center">
                        <input type="checkbox" id="statsChildFilterAll" value="all" class="mr-2" ${statsFilters.selectedChildrenIds.includes('all') ? 'checked' : ''}>
                        <label for="statsChildFilterAll">Tous les enfants</label>
                    </div>
                `;
                childrenData.forEach(child => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center';
                    div.innerHTML = `
                        <input type="checkbox" id="statsChildFilter_${child.id}" value="${child.id}" class="mr-2" ${statsFilters.selectedChildrenIds.includes(child.id) ? 'checked' : ''}>
                        <label for="statsChildFilter_${child.id}">${child.name}</label>
                    `;
                    childrenContainer.appendChild(div);
                });
            }
            
            if(dataTypesContainer) {
                dataTypesContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    cb.checked = statsFilters.dataTypes.includes(cb.value);
                });
            }
        }
        
        function filterScheduleByDateRange(schedule, start, end) {
            const startDate = new Date(start + "T00:00:00");
            const endDate = new Date(end + "T23:59:59");
            return schedule.filter(event => {
                const eventStart = new Date(event.start + "T00:00:00");
                const eventEnd = event.allDay ? new Date(new Date(event.end + "T00:00:00").getTime() - 1) : new Date(event.end + "T23:59:59"); 
                return eventStart <= endDate && eventEnd >= startDate;
            });
        }
        function filterTransitionsByDateRange(transitions, start, end) {
            const startDate = new Date(start + "T00:00:00");
            const endDate = new Date(end + "T23:59:59");
            return transitions.filter(trans => {
                const transDate = new Date(trans.date + "T" + trans.time);
                return transDate >= startDate && transDate <= endDate;
            });
        }


        function renderStatistics() {
            const dateRange = calculateDateRange(statsFilters.periodPreset, statsFilters.startDate, statsFilters.endDate);
            
            const filteredSchedule = filterScheduleByDateRange(scheduleData, dateRange.start, dateRange.end);
            const filteredTransitions = filterTransitionsByDateRange(transitionsData, dateRange.start, dateRange.end);

            document.getElementById('statsCustodyTimeSection').style.display = statsFilters.dataTypes.includes('custodyTime') ? 'block' : 'none';
            document.getElementById('statsDataAnalysisSection').style.display = (statsFilters.dataTypes.includes('custodyTime') || statsFilters.dataTypes.includes('transitions')) ? 'block' : 'none';
             document.getElementById('statsTasksSection').style.display = statsFilters.dataTypes.includes('tasks') ? 'block' : 'none';


            if (statsFilters.dataTypes.includes('custodyTime')) {
                renderStatsCustodyPieChart(filteredSchedule);
                renderStatsCustodyMonthlyChart(filteredSchedule, dateRange.start, dateRange.end);
            }
            if (statsFilters.dataTypes.includes('custodyTime') || statsFilters.dataTypes.includes('transitions')) {
                 renderStatsDataAnalysis(filteredSchedule, filteredTransitions, dateRange.start, dateRange.end);
            }
            if (statsFilters.dataTypes.includes('tasks')) {
                // This section would render task-specific stats for the selected period
                console.log("Task statistics for selected period would be rendered here.");
            }

            console.log('Statistics refreshed with filters:', statsFilters, "Date range:", dateRange);
        }

        function renderStatsCustodyPieChart(filteredSchedule) {
            if (!window.statsCustodyPieChart) return;
            let parent1Days = 0;
            let parent2Days = 0;
            const oneDay = 24 * 60 * 60 * 1000;

            filteredSchedule.forEach(event => {
                 if (!event.start || !event.end || !event.allDay) return;
                const startDate = new Date(event.start + "T00:00:00");
                const endDate = new Date(event.end + "T00:00:00");
                const duration = Math.round(Math.abs((endDate - startDate) / oneDay));

                if (event.title === settingsData.parent1Name || (event.color === settingsData.parentsColors.parent1 && event.title !== settingsData.parent2Name)) {
                    parent1Days += duration;
                } else if (event.title === settingsData.parent2Name || (event.color === settingsData.parentsColors.parent2 && event.title !== settingsData.parent1Name)) {
                    parent2Days += duration;
                }
            });
            const totalDays = parent1Days + parent2Days;
            let p1Percentage = totalDays > 0 ? Math.round((parent1Days / totalDays) * 100) : 0;
            let p2Percentage = totalDays > 0 ? (100 - p1Percentage) : 0;
            if (totalDays === 0) {p1Percentage = 0; p2Percentage = 0;}


            document.getElementById('statsParent1Percentage').textContent = `${p1Percentage}%`;
            document.getElementById('statsParent2Percentage').textContent = `${p2Percentage}%`;
            document.getElementById('statsParent1Name').textContent = settingsData.parent1Name;
            document.getElementById('statsParent2Name').textContent = settingsData.parent2Name;

            window.statsCustodyPieChart.data.labels = [settingsData.parent1Name, settingsData.parent2Name];
            window.statsCustodyPieChart.data.datasets[0].data = [p1Percentage, p2Percentage];
            window.statsCustodyPieChart.data.datasets[0].backgroundColor = [settingsData.parentsColors.parent1, settingsData.parentsColors.parent2];
            window.statsCustodyPieChart.update();
        }

        function renderStatsCustodyMonthlyChart(filteredSchedule, overallStartDateStr, overallEndDateStr) {
            if (!window.statsCustodyMonthlyChart) return;

            const monthlyData = {}; 
            const oneDay = 24 * 60 * 60 * 1000;

            const overallStartDate = new Date(overallStartDateStr + "T00:00:00");
            const overallEndDate = new Date(overallEndDateStr + "T00:00:00");

            let iterMonth = new Date(overallStartDate.getFullYear(), overallStartDate.getMonth(), 1);
            while(iterMonth <= overallEndDate) {
                const monthKey = `${iterMonth.getFullYear()}-${String(iterMonth.getMonth() + 1).padStart(2, '0')}`;
                monthlyData[monthKey] = { parent1: 0, parent2: 0, totalDaysInMonthForScheduledEvents: 0 };
                iterMonth.setMonth(iterMonth.getMonth() + 1);
            }
            
            filteredSchedule.forEach(event => {
                 if (!event.start || !event.end || !event.allDay) return;
                let currentIterDate = new Date(event.start + "T00:00:00");
                const eventEndDate = new Date(event.end + "T00:00:00");

                while(currentIterDate < eventEndDate) {
                    if (currentIterDate >= overallStartDate && currentIterDate <= overallEndDate) {
                        const monthKey = `${currentIterDate.getFullYear()}-${String(currentIterDate.getMonth() + 1).padStart(2, '0')}`;
                        if (!monthlyData[monthKey]) { 
                             monthlyData[monthKey] = { parent1: 0, parent2: 0, totalDaysInMonthForScheduledEvents: 0 };
                        }
                        
                        if (event.title === settingsData.parent1Name || (event.color === settingsData.parentsColors.parent1 && event.title !== settingsData.parent2Name)) {
                             monthlyData[monthKey].parent1 += 1;
                        } else if (event.title === settingsData.parent2Name || (event.color === settingsData.parentsColors.parent2 && event.title !== settingsData.parent1Name)) {
                            monthlyData[monthKey].parent2 += 1;
                        }
                        monthlyData[monthKey].totalDaysInMonthForScheduledEvents +=1;
                    }
                    currentIterDate.setDate(currentIterDate.getDate() + 1);
                }
            });
            
            const sortedMonthKeys = Object.keys(monthlyData).sort();
            const labels = sortedMonthKeys.map(key => {
                const [year, month] = key.split('-');
                return new Date(year, month -1).toLocaleString('fr-FR', { month: 'short', year: 'numeric'});
            });
            const parent1Percentages = sortedMonthKeys.map(key => monthlyData[key].totalDaysInMonthForScheduledEvents > 0 ? Math.round((monthlyData[key].parent1 / monthlyData[key].totalDaysInMonthForScheduledEvents) * 100) : 0);
            const parent2Percentages = sortedMonthKeys.map(key => monthlyData[key].totalDaysInMonthForScheduledEvents > 0 ? Math.round((monthlyData[key].parent2 / monthlyData[key].totalDaysInMonthForScheduledEvents) * 100) : 0);

            window.statsCustodyMonthlyChart.data.labels = labels;
            window.statsCustodyMonthlyChart.data.datasets[0].data = parent1Percentages;
            window.statsCustodyMonthlyChart.data.datasets[0].label = settingsData.parent1Name;
            window.statsCustodyMonthlyChart.data.datasets[0].backgroundColor = settingsData.parentsColors.parent1;
            window.statsCustodyMonthlyChart.data.datasets[1].data = parent2Percentages;
            window.statsCustodyMonthlyChart.data.datasets[1].label = settingsData.parent2Name;
            window.statsCustodyMonthlyChart.data.datasets[1].backgroundColor = settingsData.parentsColors.parent2;
            window.statsCustodyMonthlyChart.update();
        }

        function renderStatsDataAnalysis(filteredSchedule, filteredTransitions, startDateStr, endDateStr) {
            const listEl = document.getElementById('statsDataAnalysisList');
            if (!listEl) return;
            listEl.innerHTML = '';

            const oneDay = 24 * 60 * 60 * 1000;
            let p1Days = 0;
            let p2Days = 0;
            filteredSchedule.forEach(event => {
                 if (!event.start || !event.end || !event.allDay) return;
                const eventStart = new Date(event.start + "T00:00:00");
                const eventEnd = new Date(event.end + "T00:00:00");
                const duration = Math.round(Math.abs((eventEnd - eventStart) / oneDay));
                if (event.title === settingsData.parent1Name || (event.color === settingsData.parentsColors.parent1 && event.title !== settingsData.parent2Name)) p1Days += duration;
                else if (event.title === settingsData.parent2Name || (event.color === settingsData.parentsColors.parent2 && event.title !== settingsData.parent1Name)) p2Days += duration;
            });
            const totalDays = p1Days + p2Days;
            const p1OverallPercent = totalDays > 0 ? (p1Days / totalDays * 100).toFixed(1) : 0;
            const p2OverallPercent = totalDays > 0 ? (p2Days / totalDays * 100).toFixed(1) : 0;
            
            let balanceText = `Répartition globale: ${settingsData.parent1Name} ${p1OverallPercent}%, ${settingsData.parent2Name} ${p2OverallPercent}%.`;
            if (totalDays > 0 && Math.abs(p1OverallPercent - p2OverallPercent) <= 10) { 
                balanceText += " Garde relativement équilibrée.";
            } else if (totalDays > 0) {
                 balanceText += " Garde déséquilibrée.";
            } else {
                balanceText = "Aucune donnée de garde pour la période sélectionnée.";
            }
            listEl.innerHTML += `<li>${balanceText}</li>`;
            listEl.innerHTML += `<li>Nombre total de jours de garde pour ${settingsData.parent1Name}: ${p1Days}</li>`;
            listEl.innerHTML += `<li>Nombre total de jours de garde pour ${settingsData.parent2Name}: ${p2Days}</li>`;

            const startDate = new Date(startDateStr + "T00:00:00");
            const endDate = new Date(endDateStr + "T00:00:00");
            const numMonths = (endDate.getFullYear() - startDate.getFullYear()) * 12 + (endDate.getMonth() - startDate.getMonth()) + 1;
            const avgTransitionsPerMonth = filteredTransitions.length > 0 && numMonths > 0 ? (filteredTransitions.length / numMonths).toFixed(1) : 0;
            listEl.innerHTML += `<li>Nombre de transitions dans la période: ${filteredTransitions.length} (moyenne de ${avgTransitionsPerMonth} par mois).</li>`;

             if (window.statsCustodyMonthlyChart && window.statsCustodyMonthlyChart.data.datasets[0].data.length > 0) {
                let maxDeviation = 0;
                let maxDeviationMonth = '';
                window.statsCustodyMonthlyChart.data.datasets[0].data.forEach((p1Val, index) => {
                    const p2Val = window.statsCustodyMonthlyChart.data.datasets[1].data[index];
                    const deviation = Math.abs(p1Val - p2Val);
                    if (deviation > maxDeviation) {
                        maxDeviation = deviation;
                        maxDeviationMonth = window.statsCustodyMonthlyChart.data.labels[index];
                    }
                });
                if (maxDeviationMonth) {
                    listEl.innerHTML += `<li>Écart maximal de répartition mensuelle observé en ${maxDeviationMonth} (environ ${maxDeviation.toFixed(0)}% d'écart).</li>`;
                }
            }
        }


        function exportData() { 
            const allData = {
                settingsData,
                childrenData,
                scheduleData,
                transitionsData,
                tasksData,
                actionHistory
            };
            const jsonString = JSON.stringify(allData, null, 2);
            const blob = new Blob([jsonString], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `garde_robai_alternee_data_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert("Données exportées au format JSON!");
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (confirm("Êtes-vous sûr de vouloir importer ces données ? Toutes les données actuelles seront remplacées.")) {
                        settingsData = imported.settingsData || settingsData;
                        childrenData = imported.childrenData || [];
                        scheduleData = imported.scheduleData || [];
                        transitionsData = imported.transitionsData || [];
                        tasksData = imported.tasksData || [];
                        actionHistory = imported.actionHistory || [];

                        await localforage.setItem('settingsData', settingsData);
                        await localforage.setItem('childrenData', childrenData);
                        await localforage.setItem('scheduleData', scheduleData);
                        await localforage.setItem('transitionsData', transitionsData);
                        await localforage.setItem('tasksData', tasksData);
                        await localforage.setItem('actionHistory', actionHistory);
                        
                        alert("Données importées avec succès ! L'application va se recharger.");
                        location.reload();
                    }
                } catch (error) {
                    console.error("Erreur lors de l'importation des données:", error);
                    alert("Erreur lors de l'importation du fichier. Assurez-vous que le fichier est valide et au format JSON.");
                }
            };
            reader.readAsText(file);
            event.target.value = null; 
        }

         function setupSettingsEventListeners() {
            document.getElementById('saveAccountSettingsButton').addEventListener('click', saveAccountSettings);
            document.getElementById('themeLightButton').addEventListener('click', () => setDisplayTheme('light'));
            document.getElementById('themeDarkButton').addEventListener('click', () => setDisplayTheme('dark'));
            document.getElementById('saveDisplayPreferencesButton').addEventListener('click', saveDisplayPreferences);
            document.getElementById('exportDataButton').addEventListener('click', exportData);
            document.getElementById('importDataInput').addEventListener('change', importData);
            document.getElementById('clearActionHistoryButton').addEventListener('click', clearActionHistory);
            document.getElementById('exportCsvButton').addEventListener('click', exportDataAsCsv); // New button listener
        }

        // --- CSV Export Functions ---
        function escapeCsvValue(value) {
            if (value == null) return ''; // Handle null or undefined by returning an empty string
            const stringValue = String(value);
            if (stringValue.includes(',') || stringValue.includes('"') || stringValue.includes('\n') || stringValue.includes('\r')) {
                return `"${stringValue.replace(/"/g, '""')}"`; // Double quotes for fields containing delimiter, quote, or newline
            }
            return stringValue;
        }

        function convertToCSV(dataArray, customHeaders = null) {
            console.log("convertToCSV: Starting conversion for", dataArray.length, "items.");
            if (!dataArray || dataArray.length === 0) {
                console.warn("convertToCSV: No data to convert.");
                return "";
            }

            const headers = customHeaders || Object.keys(dataArray[0]);
            const headerRow = headers.map(escapeCsvValue).join(',');
            
            const dataRows = dataArray.map(row => {
                return headers.map(header => {
                    // Handle nested properties for scheduleData.extendedProps
                    if (header === 'isException' || header === 'reason' || header === 'generated') {
                        return escapeCsvValue(row.extendedProps ? row.extendedProps[header] : '');
                    }
                    return escapeCsvValue(row[header]);
                }).join(',');
            });
            
            const csvString = [headerRow, ...dataRows].join('\n');
            console.log("convertToCSV: Conversion completed.");
            return csvString;
        }

        function triggerCsvDownload(csvString, filename) {
            if (!csvString) {
                console.warn(`triggerCsvDownload: CSV string is empty for ${filename}. Download aborted.`);
                alert(`Aucune donnée à exporter pour ${filename}.`);
                return;
            }
            console.log(`triggerCsvDownload: Triggering download for ${filename}`);
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            console.log(`triggerCsvDownload: Download for ${filename} should have started.`);
        }

        async function exportDataAsCsv() {
            console.log("exportDataAsCsv: Starting CSV export process.");
            try {
                // 1. Children Data
                const childrenHeaders = ['id', 'name', 'dob', 'school', 'class', 'notes', 'medicalInfo_texts', 'activity_names'];
                const processedChildrenData = childrenData.map(child => ({
                    ...child,
                    medicalInfo_texts: (child.medicalInfo || []).map(mi => mi.text).join('; '),
                    activity_names: (child.activities || []).map(act => act.name).join('; ')
                }));
                const childrenCsv = convertToCSV(processedChildrenData, childrenHeaders);
                triggerCsvDownload(childrenCsv, 'enfants_export.csv');

                // 2. Schedule Data
                const scheduleHeaders = ['id', 'title', 'start', 'end', 'color', 'allDay', 'isException', 'reason', 'generated'];
                // Note: convertToCSV handles extendedProps extraction based on headers list
                const scheduleCsv = convertToCSV(scheduleData, scheduleHeaders);
                triggerCsvDownload(scheduleCsv, 'planning_export.csv');

                // 3. Transitions Data
                const transitionsHeaders = ['id', 'scheduleEventId', 'date', 'time', 'fromParent', 'toParent', 'location', 'locationId', 'confirmed', 'notes', 'autoGenerated'];
                const transitionsCsv = convertToCSV(transitionsData, transitionsHeaders);
                triggerCsvDownload(transitionsCsv, 'transitions_export.csv');
                
                // 4. Tasks Data
                const tasksHeaders = ['id', 'description', 'details', 'assignedParentName', 'category', 'categoryId', 'dueDate', 'status', 'createdAt'];
                const tasksCsv = convertToCSV(tasksData, tasksHeaders);
                triggerCsvDownload(tasksCsv, 'taches_export.csv');

                alert("Exportation CSV terminée. Vérifiez vos téléchargements.");
                actionHistory.push({ timestamp: new Date().toISOString(), user: currentParent, action: 'Exportation CSV effectuée' });
                await saveData('actionHistory', actionHistory);
                renderActionHistory();
            } catch (error) {
                console.error("exportDataAsCsv: Error during CSV export process:", error);
                alert("Une erreur est survenue lors de l'exportation CSV. Vérifiez la console.");
            }
            console.log("exportDataAsCsv: CSV export process completed.");
        }

    </script>
</body>
</html>
